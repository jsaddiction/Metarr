# Feature Specification: Metadata Completeness

**Branch:** `feature/metadata-completeness`
**Status:** In Progress
**Started:** 2025-11-19
**Last Updated:** 2025-11-20

## Overview

Enhance movie metadata display and editing with comprehensive production information, external links, and related entities (genres, directors, writers, studios, countries, tags).

## Goals

1. ‚úÖ Display production & business metadata (budget, revenue, popularity, status, language, homepage)
2. ‚úÖ Show external provider links (TMDB, IMDB, TVDB, social media, Wikidata)
3. ‚úÖ Enable editing of related entities with autocomplete (genres, directors, writers, studios, countries, tags)
4. ‚úÖ Persist user edits and make them queryable
5. ‚úÖ Populate from provider data during enrichment

## Architecture Decision

**Initial Approach:** Dual storage (normalized + denormalized columns)
- Added denormalized JSON columns to movies table for performance
- Added normalized junction tables for relationships

**Final Approach (‚úÖ Implemented):** Normalized-only storage
- Removed denormalized columns (simpler, single source of truth)
- Use only normalized tables with junction tables
- JOIN on read for better data integrity

## Implementation Status

### ‚úÖ Completed

#### Database Schema
- [x] Added production metadata columns to movies table (budget, revenue, homepage, original_language, popularity, status)
- [x] Added external_ids table for social media links
- [x] Junction tables exist: `movie_genres`, `movie_crew`, `movie_studios`, `movie_countries`, `movie_tags`
- [x] Removed denormalized columns (clean normalized approach)

#### Backend Services
- [x] **MovieRelationshipService** (NEW) - Manages junction table relationships
  - syncGenres/Directors/Writers/Studios/Countries/Tags()
  - getGenres/Directors/Writers/Studios/Countries/Tags()
  - Find-or-create pattern with atomic transactions
- [x] **GET /api/movies/:id** - JOINs normalized tables, returns arrays
- [x] **PATCH /api/movies/:id/metadata** - Syncs to normalized tables via MovieRelationshipService
- [x] **Enrichment (ProviderFetchPhase)** - Populates normalized tables from provider data
  - Maps genres, companies‚Üístudios, countries, keywords‚Üítags, crew‚Üídirectors/writers
- [x] **Suggestions API** - Already queries normalized tables (no changes needed)
  - GET /api/movies/suggestions/genres
  - GET /api/movies/suggestions/directors
  - GET /api/movies/suggestions/writers
  - GET /api/movies/suggestions/studios
  - GET /api/movies/suggestions/countries
  - GET /api/movies/suggestions/tags

#### Frontend Components
- [x] **ProviderBadge** - Clickable badges for external links with IDs as subtext
- [x] **StatusBadge** - Display movie status (Released, Post Production, etc.)
- [x] **CurrencyDisplay** - Format budget/revenue with locale
- [x] **PopularityIndicator** - Visual popularity score
- [x] **TagInput** (NEW) - Custom component for editing arrays
  - Badge display with remove buttons
  - Fuzzy search autocomplete (Fuse.js)
  - Keyboard navigation (‚Üë‚Üì, Enter, Escape, Backspace)
  - Optional lock/unlock support
  - Purple accent styling
- [x] **MetadataTab** - Integrated all components
  - Production & Stats section (badge layout)
  - External Links section (provider badges)
  - Related Entities section (6 TagInput fields)
  - Inline Save/Reset buttons (replaced SaveBar)
  - Real-time suggestions from API

#### UI/UX Improvements
- [x] Removed redundant fields (consolidated TMDB/IMDB IDs into badges)
- [x] Improved badge readability (larger text, neutral colors)
- [x] Replaced floating SaveBar with inline buttons
- [x] Purple accent styling for editable tags
- [x] Lock buttons hidden for array fields (no lock support in normalized approach)

#### Bug Fixes
- [x] Fixed TypeScript errors in migration (db.all ‚Üí db.query)
- [x] Fixed enrichment not populating related fields
- [x] Fixed user-created tags not appearing in suggestions

### üîÑ In Progress

None - all planned features complete for this phase.

### ‚ùå Not Started / Future Enhancements

#### Lock Support for Related Entities
- Current: No lock support for array fields (genres, directors, etc.)
- Reason: Lock fields removed from normalized schema
- Future: Could implement junction-table-level locks or per-relationship locks if needed

#### Cast Management
- Current: Cast handled on separate Actors tab
- Includes images, so uses different UI pattern
- Already functional, just separate from related entities

#### Advanced Features (Out of Scope)
- Bulk editing multiple movies
- Import/export metadata
- Metadata validation rules
- Audit log for changes

## Testing Checklist

### Manual Testing Required

- [ ] **Enrichment Flow**
  1. Restart backend (runs migrations)
  2. Scan a library
  3. Enrich movies
  4. Verify genres, directors, writers, studios, countries populated
  5. Check metadata tab shows all fields

- [ ] **User Edits Flow**
  1. Open movie metadata tab
  2. Add custom tag "test-tag"
  3. Save changes
  4. Open different movie
  5. Type "test" in tags field
  6. Verify "test-tag" appears in suggestions

- [ ] **Autocomplete**
  1. Click in each TagInput field (Genres, Directors, Writers, Studios, Countries, Tags)
  2. Type partial text
  3. Verify fuzzy search suggestions appear
  4. Select suggestion with Enter or click
  5. Verify badge appears

- [ ] **Save/Reset**
  1. Make changes to multiple fields
  2. Verify Save button enables
  3. Click Save - verify success toast
  4. Reload page - verify changes persisted
  5. Make changes again
  6. Click Reset - verify reverts to saved state

- [ ] **Visual Appearance**
  1. Check Production & Stats badge layout
  2. Check External Links badges with IDs
  3. Check TagInput purple badges
  4. Check inline Save/Reset buttons
  5. Verify responsive design

## Files Modified

### Backend
- `src/database/migrations/20251015_001_clean_schema.ts` - Removed denormalized columns, fixed .all() errors
- `src/types/database-models.ts` - Removed denormalized fields from MovieRow
- `src/services/movie/MovieRelationshipService.ts` - NEW (444 lines)
- `src/services/movie/MovieCrudService.ts` - Sync to normalized tables
- `src/services/movieService.ts` - JOIN normalized tables on GET
- `src/services/movie/MovieQueryService.ts` - JOIN normalized tables on GET
- `src/services/enrichment/phases/ProviderFetchPhase.ts` - Populate normalized from providers
- `src/controllers/movie/MovieSuggestionsController.ts` - Already existed, no changes
- `src/routes/api.ts` - Suggestion routes already existed

### Frontend
- `public/frontend/src/components/ui/TagInput.tsx` - NEW custom component
- `public/frontend/src/components/ui/ProviderBadge.tsx` - Enhanced with showId prop
- `public/frontend/src/components/ui/StatusBadge.tsx` - NEW
- `public/frontend/src/components/ui/CurrencyDisplay.tsx` - NEW
- `public/frontend/src/components/ui/PopularityIndicator.tsx` - NEW
- `public/frontend/src/components/movie/MetadataTab.tsx` - Major refactor
- `public/frontend/src/utils/api.ts` - Added suggestion methods
- `public/frontend/src/hooks/useMovies.ts` - Added suggestion hooks
- `public/frontend/src/utils/languages.ts` - Already existed

### Documentation
- `docs/operations/RELATED_ENTITIES_MIGRATION.md` - Data migration guide
- `.feature-spec-metadata-completeness.md` - This document

## Known Issues

None at this time. All TypeScript and build errors resolved.

## Next Steps

1. **User Testing** - Complete manual testing checklist above
2. **Monitor for Issues** - Watch for edge cases during normal use
3. **Consider Enhancements** - Evaluate need for lock support on array fields
4. **Merge to Main** - When testing complete and stable

## Decision Log

### 2025-11-19: Initial Implementation
- Implemented dual storage (normalized + denormalized)
- Created 6 UI components
- Added production & external links

### 2025-11-20: Architecture Change
- **Decision:** Move to normalized-only storage
- **Reason:** User reported two issues:
  1. Enrichment didn't populate fields (no sync from providers)
  2. User-created tags didn't appear in suggestions (no sync to normalized)
- **Impact:** Simpler architecture, single source of truth, immediate fix for both issues
- **Trade-off:** Slightly slower reads (JOIN overhead) vs. eliminated sync complexity

### 2025-11-20: Lock Support Removed
- **Decision:** No lock support for array fields in normalized approach
- **Reason:** Lock fields were in denormalized columns (removed)
- **Alternative:** Could implement in future if needed via:
  - Junction-table-level locks
  - Per-relationship lock flags
  - Movie-level disable flag for each entity type

## Migration Path

If reverting to denormalized approach needed:
1. Add columns back to movies table schema
2. Add sync logic in both directions
3. Re-implement lock support
4. Update MovieCrudService to write to both places

Not recommended - normalized approach is cleaner and working well.
