# Development Dockerfile for Metarr
# Supports PUID/PGID like LinuxServer.io containers
# Includes hot-reload support via volume mounts

FROM node:20-bookworm-slim

# Install system dependencies
# - git: for npm packages that pull from git
# - python3/make/g++: for native node modules (sqlite3, sharp)
# - imagemagick: for phash-imagemagick
# - gosu: for stepping down from root to app user
RUN apt-get update && apt-get install -y \
    git \
    python3 \
    make \
    g++ \
    imagemagick \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# Create app user and group with default IDs (will be modified at runtime)
RUN groupadd -g 1000 metarr && \
    useradd -u 1000 -g metarr -m -s /bin/bash metarr

# Create directories
# /app = source code (will be volume mounted)
# /node_modules = dependencies (stays in container, not mounted)
# /data = persistent data
RUN mkdir -p /app /node_modules /data && \
    chown -R metarr:metarr /app /node_modules /data

# Set working directory
WORKDIR /app

# Install dependencies to /node_modules (outside of /app)
# This way the host mount of /app doesn't affect node_modules
ENV NODE_PATH=/node_modules
ENV PATH="/node_modules/.bin:${PATH}"

# Copy package files and install to /node_modules
COPY package*.json ./
RUN npm ci --prefix / && \
    chown -R metarr:metarr /node_modules

# Copy the rest of the application
# In development, this is overridden by volume mount
COPY . .

# Copy entrypoint script
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Expose single port - Vite proxies API requests internally
# 3001 = Vite dev server (proxies /api/* to backend on 3000 internally)
EXPOSE 3001

# Use entrypoint to handle PUID/PGID
ENTRYPOINT ["/docker-entrypoint.sh"]

# Default command for development
CMD ["npm", "run", "dev:all"]
