# Development Dockerfile for Metarr
# Supports PUID/PGID like LinuxServer.io containers
# Includes hot-reload support via volume mounts

FROM node:20-bookworm-slim

# Install system dependencies
# - git: for npm packages that pull from git
# - python3/make/g++: for native node modules (sqlite3, sharp)
# - imagemagick: for phash-imagemagick
# - gosu: for stepping down from root to app user
RUN apt-get update && apt-get install -y \
    git \
    python3 \
    make \
    g++ \
    imagemagick \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# Create abc user and group with placeholder IDs
# These will be modified at runtime by the entrypoint to match PUID/PGID
RUN groupadd -g 911 abc && \
    useradd -u 911 -g abc -m -s /bin/bash abc

# Create directories
RUN mkdir -p /app /data

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies to /node_modules (outside /app to avoid volume shadow)
# Keep node_modules owned by root - Node.js only needs read access
# This avoids slow usermod scanning at runtime when PUID/PGID changes
RUN npm ci && \
    mv node_modules /node_modules && \
    chown abc:abc /data

# Set NODE_PATH so Node finds modules in /node_modules
ENV NODE_PATH=/node_modules
ENV PATH="/node_modules/.bin:${PATH}"

# Copy the rest of the application
# In development, this is overridden by volume mount
COPY . .

# Copy entrypoint script
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Expose single port - Vite proxies API requests internally
# 3001 = Vite dev server (proxies /api/* to backend on 3000 internally)
EXPOSE 3001

# Use entrypoint to handle PUID/PGID
ENTRYPOINT ["/docker-entrypoint.sh"]

# Default command for development
CMD ["npm", "run", "dev:all"]
