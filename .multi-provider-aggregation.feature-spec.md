# Multi-Provider Metadata Aggregation - Feature Specification

**Status**: Planning Complete - Ready for Implementation
**Branch**: `feature/metadata-completeness`
**Target Version**: v2.0
**Created**: 2025-11-21

---

## Executive Summary

Redesign Metarr's provider system to support intelligent multi-provider metadata aggregation with graceful rate limit handling. The system will query all enabled providers in parallel, apply field-level authority rules, and continue enrichment even when individual providers are rate-limited.

**Core Principle**: **Graceful degradation over complex orchestration**

### Key Goals

1. **Provider-agnostic architecture** - Works with 3 or 30 providers without code changes
2. **Graceful rate limit handling** - Rate-limited providers don't break enrichment
3. **Smart metadata aggregation** - Field-level authority (OMDB for ratings, TMDB for plot)
4. **Change tracking** - Detect what changed to trigger player sync only when needed
5. **Simple caching** - Uniform 7-day TTL, no per-provider complexity
6. **UI-driven configuration** - All settings in database/UI, no environment variables

### Problem Statement

**Current Issues**:
- OMDB provider implemented but not integrated into enrichment
- No multi-provider metadata merging (only TMDB used)
- Rate limit failures block entire enrichment job
- No field authority system (OMDB's authoritative ratings ignored)
- Provider configuration scattered (some in code, some in config files)

**Example Scenario**:
```
User scans 1,000 movies:
- Movie 1-500: TMDB âœ“, OMDB âœ“ â†’ Complete metadata
- Movie 501: OMDB hits daily quota (1,000 requests)
- Current behavior: Enrichment FAILS for movie 501-1000
- Desired behavior: Continue with TMDB, mark OMDB incomplete, retry tomorrow
```

---

## Architecture Design

### High-Level Flow

```
EnrichmentJob(entityId, mode='auto'|'manual')
  â”‚
  â”œâ”€ If mode='auto' && !monitored â†’ SKIP
  â”‚
  â”œâ”€ Query ALL enabled providers (parallel)
  â”‚   â”œâ”€ Provider A: Success â†’ metadata
  â”‚   â”œâ”€ Provider B: RateLimitError â†’ skip gracefully
  â”‚   â””â”€ Provider C: Success â†’ metadata
  â”‚
  â”œâ”€ Aggregate responses using field authority
  â”‚
  â”œâ”€ Detect changes (for player sync)
  â”‚
  â””â”€ Update entity (respect locks, fill nulls)
```

### Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EnrichmentOrchestrator                         â”‚
â”‚  - Coordinates enrichment jobs                  â”‚
â”‚  - Applies automatic vs manual logic            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MetadataAggregator (NEW)                       â”‚
â”‚  - Queries all providers in parallel            â”‚
â”‚  - Applies field authority rules                â”‚
â”‚  - Detects changes                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼           â–¼           â–¼
   ProviderA   ProviderB   ProviderC
   (TMDB)      (OMDB)      (Fanart)
        â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProviderCacheOrchestrator                      â”‚
â”‚  - Manages per-provider caching                 â”‚
â”‚  - 7-day TTL for all providers                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Features

### 1. Universal Provider Interface

All providers implement standard interface:

```typescript
interface MetadataProvider {
  readonly id: ProviderId;
  readonly name: string;

  getCapabilities(): ProviderCapabilities;
  getRateLimitStatus(): RateLimitStatus;

  search(request: SearchRequest): Promise<SearchResult[]>;
  getMetadata(request: MetadataRequest): Promise<MetadataResponse>;
  getAssets(request: AssetRequest): Promise<AssetCandidate[]>;
}
```

**Enhanced Response** includes enrichment metadata:

```typescript
interface EnrichedProviderResponse extends MetadataResponse {
  enrichmentMetadata: {
    cacheHit: boolean;          // From cache?
    cacheAge?: number;           // Age in seconds
    fetchedAt: Date;
    rateLimited?: boolean;       // Hit rate limit?
    retryAfter?: number;         // Retry delay
  };
}
```

### 2. Field Authority System

**Configuration** (stored in database):

```typescript
interface FieldAuthorityConfig {
  // Global provider priority
  providerPriority: ProviderId[];  // ['omdb', 'tmdb', 'tvdb', 'fanart']

  // Field-specific overrides
  fieldAuthorities: {
    'imdb_rating': {
      providers: ['omdb'],      // OMDB only
      exclusive: true           // Don't fall back
    },
    'plot': {
      providers: ['omdb', 'tmdb'],
      exclusive: false          // Use TMDB if OMDB missing
    }
  };

  fillGaps: boolean;  // Use secondary providers for null fields
}
```

**Aggregation Algorithm**:

```typescript
function aggregateMetadata(
  responses: EnrichedProviderResponse[],
  config: FieldAuthorityConfig
): AggregatedMetadata {

  const merged = {};
  const sources = {};  // Track which provider supplied each field

  for (const field of allFields) {
    const authorities = config.fieldAuthorities[field]?.providers
      || config.providerPriority;

    for (const providerId of authorities) {
      const value = responses[providerId]?.[field];

      // Treat empty string as null (Decision: Q1)
      if (value !== null && value !== undefined && value !== '') {
        merged[field] = value;
        sources[field] = providerId;

        // Stop if exclusive or not filling gaps
        if (config.fieldAuthorities[field]?.exclusive || !config.fillGaps) {
          break;
        }
        break;  // Found first value
      }
    }
  }

  return { fields: merged, sources };
}
```

### 3. Graceful Rate Limit Handling

**Provider-Level State** (in-memory, optional DB persistence):

```typescript
interface ProviderRateLimitState {
  providerId: ProviderId;
  exhaustedAt?: Date;
  resetAt?: Date;
  consecutiveRateLimits: number;
}

const rateLimitStates = new Map<ProviderId, ProviderRateLimitState>();
```

**Enrichment with Graceful Degradation** (Decision: Q2):

```typescript
async function enrichEntity(entityId: number, mode: 'auto' | 'manual') {
  const providers = await getEnabledProviders();

  // Query all providers in parallel
  const responses = await Promise.allSettled(
    providers.map(p => {
      // Check rate limit before fetch (fail fast)
      if (isProviderRateLimited(p.id)) {
        return { providerId: p.id, rateLimited: true };
      }

      return p.fetchMetadata({ entityId });
    })
  );

  // Extract successful responses
  const successful = responses.filter(r =>
    r.status === 'fulfilled' && !r.value.rateLimited
  );

  // Log rate-limited providers (no user alert)
  const rateLimited = responses.filter(r =>
    r.status === 'fulfilled' && r.value.rateLimited
  ).map(r => r.value.providerId);

  if (rateLimited.length > 0) {
    logger.info(`Providers rate limited: ${rateLimited.join(', ')}`);
  }

  // Continue with successful providers
  const aggregated = aggregateMetadata(successful, fieldAuthorityConfig);

  // Update entity
  await updateEntity(entityId, aggregated);
}
```

**Rate Limit Detection**:
- TMDB: Only detected via 429 response
- OMDB: Pre-checked via quota tracker
- Each provider handles rate limits independently

### 4. Change Detection

**Purpose**: Trigger player sync only when fields change

```typescript
interface EntityChangeset {
  entityId: number;
  changedFields: Array<{
    field: string;
    oldValue: unknown;
    newValue: unknown;
    source: ProviderId;
  }>;
  requiresPlayerSync: boolean;
  syncReason?: string;
}

const PLAYER_SYNC_FIELDS = [
  'title', 'plot', 'poster', 'fanart',
  'imdb_rating', 'release_date', 'actors'
];

function detectChanges(oldData, newData, lockedFields): EntityChangeset {
  const changes = [];

  for (const [field, newValue] of Object.entries(newData.fields)) {
    if (lockedFields.includes(field)) continue;

    const oldValue = oldData[field];
    if (!isEqual(oldValue, newValue)) {
      changes.push({ field, oldValue, newValue, source: newData.sources[field] });
    }
  }

  const requiresSync = changes.some(c => PLAYER_SYNC_FIELDS.includes(c.field));

  return { entityId, changedFields: changes, requiresPlayerSync, ... };
}
```

### 5. Simple Caching

**Strategy**: Uniform 7-day TTL across all providers

```typescript
const CACHE_TTL_SECONDS = 7 * 24 * 60 * 60;  // 7 days

function isCacheFresh(fetchedAt: Date): boolean {
  const ageSeconds = (Date.now() - fetchedAt.getTime()) / 1000;
  return ageSeconds < CACHE_TTL_SECONDS;
}
```

**Storage**: Use existing `provider_cache_*` tables

**Cache Flow**:
1. Check cache by external IDs (tmdb_id, imdb_id)
2. If fresh (< 7 days) â†’ return cached
3. If stale â†’ fetch from API, update cache
4. Force refresh flag bypasses cache

### 6. Scheduled Enrichment

**Single Job**: `enrichALL` runs daily at 3 AM

```typescript
async function enrichALL() {
  const entities = await db.all(`
    SELECT id, type, monitored
    FROM entities
    WHERE deleted_at IS NULL
  `);

  for (const entity of entities) {
    await jobQueue.add('enrich', {
      entityId: entity.id,
      mode: 'auto',  // Skips unmonitored
      priority: 'background',
      forceRefresh: false  // Use cache
    });
  }
}

cron.schedule('0 3 * * *', enrichALL);
```

**How it works**:
- Queries all entities
- Cache automatically filters fresh items (no API call)
- Rate-limited providers skipped gracefully
- Runs continuously (1,000+ entities OK)

---

## Database Schema Changes

### Minimal Changes Required

```sql
-- Track last enrichment
ALTER TABLE movies ADD COLUMN last_enriched_at TIMESTAMP;
ALTER TABLE movies ADD COLUMN last_enriched_providers TEXT;  -- JSON: ['omdb', 'tmdb']

ALTER TABLE series ADD COLUMN last_enriched_at TIMESTAMP;
ALTER TABLE series ADD COLUMN last_enriched_providers TEXT;

-- Provider configuration (NEW TABLE)
CREATE TABLE provider_config (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  provider_id TEXT NOT NULL UNIQUE,
  provider_name TEXT NOT NULL,
  enabled BOOLEAN NOT NULL DEFAULT 1,

  -- Rate limiting
  rate_limit_requests INTEGER,
  rate_limit_window_seconds INTEGER,
  daily_quota INTEGER,  -- For OMDB, etc.

  -- Priority
  priority_order INTEGER,

  -- Metadata
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Field authority configuration (NEW TABLE)
CREATE TABLE field_authorities (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  field_name TEXT NOT NULL UNIQUE,
  provider_priority TEXT NOT NULL,  -- JSON: ['omdb', 'tmdb']
  exclusive BOOLEAN DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Optional: Rate limit state persistence
CREATE TABLE provider_rate_limit_state (
  provider_id TEXT PRIMARY KEY,
  exhausted_at TIMESTAMP,
  reset_at TIMESTAMP,
  consecutive_rate_limits INTEGER DEFAULT 0,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Optional: Enrichment history log
CREATE TABLE entity_enrichment_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,
  entity_id INTEGER NOT NULL,
  enrichment_mode TEXT NOT NULL,  -- 'auto' | 'manual'
  providers TEXT NOT NULL,  -- JSON: provider IDs used
  changed_fields TEXT,  -- JSON: changed field details
  requires_player_sync BOOLEAN,
  sync_reason TEXT,
  enriched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_enrichment_log_entity ON entity_enrichment_log(entity_type, entity_id);
```

---

## API Changes

### New Endpoints

#### 1. Provider Health Status

```
GET /api/providers/health
```

**Response**:
```json
{
  "providers": [
    {
      "id": "omdb",
      "name": "OMDB API",
      "enabled": true,
      "healthy": false,
      "rateLimited": true,
      "rateLimitResetAt": "2025-11-22T00:00:00Z",
      "rateLimitReason": "Daily quota exhausted (1000/1000)"
    },
    {
      "id": "tmdb",
      "name": "TMDB",
      "enabled": true,
      "healthy": true,
      "rateLimited": false
    }
  ]
}
```

#### 2. Provider Configuration

```
GET /api/providers/config
PUT /api/providers/config/:providerId
```

**Request**:
```json
{
  "enabled": true,
  "rateLimitRequests": 10,
  "rateLimitWindowSeconds": 1,
  "dailyQuota": 1000,
  "priorityOrder": 1
}
```

#### 3. Field Authority Configuration

```
GET /api/providers/field-authorities
PUT /api/providers/field-authorities
```

**Request**:
```json
{
  "providerPriority": ["omdb", "tmdb", "tvdb"],
  "fieldAuthorities": {
    "imdb_rating": {
      "providers": ["omdb"],
      "exclusive": true
    },
    "plot": {
      "providers": ["omdb", "tmdb"],
      "exclusive": false
    }
  },
  "fillGaps": true
}
```

#### 4. Manual Enrichment

```
POST /api/entities/:type/:id/enrich
```

**Request**:
```json
{
  "forceRefresh": true,
  "providers": ["omdb", "tmdb"]  // Optional: specific providers only
}
```

**Response**:
```json
{
  "success": true,
  "changeset": {
    "changedFields": ["imdb_rating", "plot"],
    "requiresPlayerSync": true,
    "syncReason": "Changed: imdb_rating"
  },
  "providers": ["omdb", "tmdb"],
  "rateLimited": ["tvdb"]
}
```

---

## UI Requirements

### 1. Provider Configuration Page

**Location**: Settings â†’ Providers

**Layout**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider Configuration                              [Save]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Provider Priority (Drag to Reorder)                     â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ 1. â˜° OMDB API                    [âœ“] [Settings]        â”‚ â”‚
â”‚ â”‚ 2. â˜° TMDB                        [âœ“] [Settings]        â”‚ â”‚
â”‚ â”‚ 3. â˜° TVDB                        [âœ“] [Settings]        â”‚ â”‚
â”‚ â”‚ 4. â˜° Fanart.tv                   [âœ“] [Settings]        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Field Authority Overrides (Optional)                    â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ IMDb Rating:    [OMDB only â–¼]           [â˜‘] Exclusive  â”‚ â”‚
â”‚ â”‚ Plot:           [OMDB > TMDB â–¼]         [â˜] Exclusive  â”‚ â”‚
â”‚ â”‚ Poster:         [TMDB > Fanart â–¼]       [â˜] Exclusive  â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ [+ Add Override]                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Fill Gaps:  [âœ“] Use secondary providers for null fieldsâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Provider Settings Modal

**Triggered by**: [Settings] button in provider row

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OMDB API Configuration                          [Cancel] [Save]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚ Enabled:        [âœ“]                                          â”‚
â”‚                                                               â”‚
â”‚ API Key:        [************3f2a]              [Test]       â”‚
â”‚                                                               â”‚
â”‚ Rate Limiting:                                                â”‚
â”‚   Requests:     [10] per [1] seconds                         â”‚
â”‚   Daily Quota:  [1000] requests                              â”‚
â”‚                 (Free: 1000, Paid: 100,000)                  â”‚
â”‚                                                               â”‚
â”‚ Current Status: âš  Rate Limited                               â”‚
â”‚                 Resets at: 2025-11-22 12:00 AM UTC           â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Usage Today:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘  870 / 1000 (87%)           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Provider Health Dashboard

**Location**: Settings â†’ Providers â†’ Health tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider Health Status                      [Auto-refresh: 30s]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚ â— OMDB API         âœ“ Healthy                                â”‚
â”‚   Status: OK       Usage: 145/1000 (15%)                     â”‚
â”‚   Last request: 2 minutes ago                                â”‚
â”‚                                                               â”‚
â”‚ â— TMDB             âœ“ Healthy                                â”‚
â”‚   Status: OK       Rate limit: None                          â”‚
â”‚   Last request: 5 seconds ago                                â”‚
â”‚                                                               â”‚
â”‚ âš  TVDB            âœ— Rate Limited                            â”‚
â”‚   Status: 429      Resets in: 45 minutes                     â”‚
â”‚   Last request: Failed 45 minutes ago                        â”‚
â”‚                                                               â”‚
â”‚ â— Fanart.tv        âœ“ Healthy                                â”‚
â”‚   Status: OK       Rate limit: None                          â”‚
â”‚   Last request: 10 minutes ago                               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Entity Enrichment Status (Movie Detail Page)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metadata                                      [Refresh Metadata]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚ Last Enriched: 2 days ago                                    â”‚
â”‚ Providers: OMDB, TMDB, Fanart.tv                            â”‚
â”‚                                                               â”‚
â”‚ Title:         Inception                     ğŸ”’ (Locked)     â”‚
â”‚ Plot:          Cobb, a skilled thief...      [OMDB]          â”‚
â”‚ IMDb Rating:   8.8                           [OMDB]          â”‚
â”‚ Poster:        [thumbnail]                   [TMDB]          â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Note**: Show provider source badge `[OMDB]` next to each field (optional toggle)

---

## Implementation Phases

### Phase 1: Core Infrastructure (Week 1)

**Tasks**:
1. Create `MetadataAggregator` class
2. Implement `aggregateMetadata()` function with field authority
3. Implement `detectChanges()` function
4. Add `enrichmentMetadata` to provider responses
5. Create database tables (`provider_config`, `field_authorities`)

**Deliverables**:
- `src/services/enrichment/MetadataAggregator.ts`
- `src/types/enrichment.ts` (new types)
- Migration: `20251121_002_provider_aggregation.ts`

**Tests**:
- Unit: `aggregateMetadata()` with various field authorities
- Unit: `detectChanges()` with locked fields

---

### Phase 2: Rate Limit Handling (Week 1)

**Tasks**:
1. Implement in-memory rate limit state store
2. Add `isProviderRateLimited()` check
3. Update enrichment flow to skip rate-limited providers
4. Implement graceful degradation logic
5. Add rate limit logging

**Deliverables**:
- `src/services/providers/RateLimitStateManager.ts`
- Enhanced `EnrichmentOrchestrator.enrichEntity()`

**Tests**:
- Integration: Enrichment with one provider rate-limited
- Unit: Rate limit state management
- Unit: Cache freshness checks

---

### Phase 3: Provider Configuration (Week 2)

**Tasks**:
1. Create provider configuration service
2. Implement API endpoints (health, config, field authorities)
3. Seed default configuration in migration
4. Add provider health monitoring

**Deliverables**:
- `src/services/ProviderConfigService.ts`
- API routes: `/api/providers/*`
- Migration: Seed default configs

**Tests**:
- Integration: Provider config CRUD
- Integration: Field authority updates

---

### Phase 4: UI Implementation (Week 2)

**Tasks**:
1. Provider configuration page (drag-drop priority)
2. Provider settings modal (rate limits, API keys)
3. Field authority override editor
4. Provider health dashboard
5. Entity enrichment status display

**Deliverables**:
- `public/frontend/src/pages/settings/Providers.tsx`
- `public/frontend/src/components/providers/*`

**Tests**:
- Manual: Drag-drop priority
- Manual: Provider enable/disable
- Manual: Rate limit configuration
- Manual: Health dashboard real-time updates

---

### Phase 5: Scheduled Enrichment & Integration (Week 3)

**Tasks**:
1. Implement `enrichALL()` scheduled job
2. Add cron scheduling
3. Integrate OMDB into enrichment flow
4. Update existing enrichment phases
5. Add enrichment history logging (optional)
6. Performance testing with 1,000+ entities

**Deliverables**:
- `src/services/jobs/enrichALL.ts`
- Enhanced `ProviderFetchPhase`
- Cron schedule initialization

**Tests**:
- Integration: Scheduled enrichment job
- Integration: Multi-provider enrichment (TMDB + OMDB + Fanart)
- Performance: 1,000 entities with mixed cache states
- Manual: Full enrichment workflow end-to-end

---

## Testing Strategy

### Unit Tests

**Coverage**: 80%+ for new code

**Key Test Suites**:

1. **Metadata Aggregation** (`aggregateMetadata.test.ts`)
   - Field authority priority
   - Exclusive vs fill-gaps modes
   - Empty string = null handling
   - Provider source tracking

2. **Change Detection** (`detectChanges.test.ts`)
   - Detect field changes
   - Respect locked fields
   - Player sync triggers
   - Deep equality (arrays, objects)

3. **Rate Limit State** (`rateLimitState.test.ts`)
   - State tracking
   - Reset time calculation
   - Consecutive limit counter

4. **Cache Freshness** (`cacheFreshness.test.ts`)
   - TTL validation
   - Force refresh bypass

### Integration Tests

**Coverage**: Critical paths

**Key Test Scenarios**:

1. **Multi-Provider Enrichment**
   - All providers succeed
   - One provider rate-limited
   - All providers rate-limited (should fail)

2. **Field Authority Application**
   - OMDB provides rating, TMDB provides plot
   - OMDB missing plot, TMDB fills gap
   - Exclusive field (OMDB only for rating)

3. **Change Detection & Player Sync**
   - Field changes trigger sync
   - No changes, no sync
   - Locked fields not synced

4. **Scheduled Enrichment**
   - Job queues all entities
   - Respects monitored status (auto mode)
   - Uses cache for fresh items

### Manual Testing

**Scenarios**:

1. **Provider Configuration**
   - Enable/disable providers
   - Change provider priority
   - Add field authority override
   - Configure OMDB daily quota

2. **Rate Limit Handling**
   - Mock OMDB quota exhaustion
   - Verify enrichment continues
   - Check provider health dashboard

3. **Enrichment Workflow**
   - Manual refresh (force)
   - Automatic refresh (cache)
   - Mid-scan rate limit

4. **UI Responsiveness**
   - Provider health real-time updates
   - Enrichment status on movie detail
   - Provider configuration saves

---

## Success Criteria

### Functional Requirements

- âœ… OMDB provider integrated into enrichment flow
- âœ… Multi-provider metadata aggregation working
- âœ… Field authority rules applied correctly
- âœ… Rate-limited providers skipped gracefully
- âœ… Change detection triggers player sync
- âœ… Provider configuration via UI (no environment variables)
- âœ… Scheduled enrichment runs daily

### Performance Requirements

- âœ… Enrichment of 1,000 movies completes within 2 hours
- âœ… Cache hit rate > 80% on scheduled enrichment
- âœ… Rate limit state lookup < 10ms
- âœ… Metadata aggregation < 50ms per entity

### User Experience Requirements

- âœ… Provider health visible in settings
- âœ… Rate limit status clear (no silent failures)
- âœ… Field source attribution visible on entity detail
- âœ… Provider priority configurable via drag-drop
- âœ… No user alerts on rate limits (log only)

---

## Risk Analysis

### High Risk

**1. OMDB Daily Quota Exhaustion**
- **Risk**: Free tier (1,000/day) exhausted quickly during initial scan
- **Mitigation**:
  - Aggressive 7-day caching
  - User notification to upgrade to paid tier
  - Scheduled enrichment spreads requests over 24 hours

**2. Provider API Changes**
- **Risk**: Provider changes API response format, breaks parsing
- **Mitigation**:
  - Comprehensive error handling
  - Provider version tracking
  - Fallback to other providers

### Medium Risk

**3. Cache Invalidation Complexity**
- **Risk**: Stale cache served after provider data changes
- **Mitigation**:
  - Force refresh option
  - 7-day TTL balances freshness vs API usage

**4. Database Migration Failures**
- **Risk**: Schema changes fail on production database
- **Mitigation**:
  - Additive migrations only (no destructive changes)
  - Rollback plan tested
  - Backup before migration

### Low Risk

**5. Rate Limit State Loss on Restart**
- **Risk**: In-memory state lost on server restart
- **Mitigation**:
  - Optional DB persistence
  - Conservative rate limits

---

## Rollback Plan

### Phase 1-2 (Core Infrastructure)
- **Rollback**: Revert migration, remove new services
- **Impact**: None (no user-facing changes yet)

### Phase 3 (Provider Configuration)
- **Rollback**: Revert API endpoints, keep database
- **Impact**: Settings page broken (temporary)

### Phase 4 (UI)
- **Rollback**: Revert frontend changes
- **Impact**: Settings page reverts to old design

### Phase 5 (Integration)
- **Rollback**: Disable scheduled job, revert enrichment phases
- **Impact**: Enrichment returns to TMDB-only

**Feature Flag**: Add `ENABLE_MULTI_PROVIDER_AGGREGATION` flag for gradual rollout

---

## Documentation Updates Required

### User Documentation

1. **Getting Started**
   - Update provider setup instructions
   - Add OMDB API key acquisition steps

2. **Configuration Guide**
   - Provider priority configuration
   - Field authority setup
   - Rate limit configuration

3. **Troubleshooting**
   - Rate limit errors
   - Provider health issues
   - Cache invalidation

### Developer Documentation

1. **Architecture**
   - Update provider system overview
   - Add metadata aggregation flow diagram

2. **API Reference**
   - New provider endpoints
   - Enrichment status endpoints

3. **Provider Development Guide**
   - How to add new providers
   - Rate limit implementation
   - Cache integration

---

## Open Questions

*To be resolved during implementation:*

1. **Provider Health Polling**: Poll every 30s or WebSocket-based real-time?
2. **Change Log Retention**: Keep enrichment history forever or prune after N days?
3. **Rate Limit State Persistence**: In-memory only or add DB persistence?
4. **Field Authority UI**: Simple dropdown or advanced visual editor?

---

## Appendix A: Field Authority Default Configuration

```json
{
  "providerPriority": ["omdb", "tmdb", "tvdb", "fanart"],
  "fieldAuthorities": {
    "imdb_rating": { "providers": ["omdb"], "exclusive": true },
    "imdb_votes": { "providers": ["omdb"], "exclusive": true },
    "rotten_tomatoes_score": { "providers": ["omdb"], "exclusive": true },
    "metacritic_score": { "providers": ["omdb"], "exclusive": true },
    "awards": { "providers": ["omdb"], "exclusive": true },
    "outline": { "providers": ["omdb"], "exclusive": true },
    "plot": { "providers": ["tmdb", "omdb"], "exclusive": false },
    "title": { "providers": ["tmdb", "omdb"], "exclusive": false },
    "cast": { "providers": ["tmdb", "omdb"], "exclusive": false },
    "genres": { "providers": ["tmdb", "tvdb"], "exclusive": false },
    "poster": { "providers": ["tmdb", "fanart"], "exclusive": false },
    "fanart": { "providers": ["fanart", "tmdb"], "exclusive": false }
  },
  "fillGaps": true
}
```

---

## Appendix B: Provider Comparison Matrix

| Feature | TMDB | OMDB | TVDB | Fanart.tv |
|---------|------|------|------|-----------|
| **Metadata** | âœ“âœ“âœ“ | âœ“âœ“ | âœ“âœ“ | âœ— |
| **Images** | âœ“âœ“ | âœ“ | âœ“âœ“ | âœ“âœ“âœ“ |
| **Rate Limit** | Unlimited* | 1k/day | 30 req/10s | 10 req/s |
| **IMDb Ratings** | âœ“ (copy) | âœ“âœ“âœ“ (official) | âœ— | âœ— |
| **RT Scores** | âœ— | âœ“âœ“âœ“ (only) | âœ— | âœ— |
| **Trailers** | âœ“âœ“âœ“ | âœ— | âœ— | âœ— |
| **Episode Data** | âœ“âœ“ | âœ— | âœ“âœ“âœ“ | âœ— |

*TMDB unlimited until 429 response

---

**End of Specification**
