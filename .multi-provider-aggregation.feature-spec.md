# Multi-Provider Metadata Aggregation - Feature Specification

**Status**: Planning Complete - Ready for Implementation
**Branch**: `feature/metadata-completeness`
**Target Version**: v2.0
**Created**: 2025-11-21
**Updated**: 2025-11-21

---

## Executive Summary

Redesign Metarr's provider system to support intelligent multi-provider metadata aggregation with a focus on **increasing completeness over time** while **never regressing** (replacing data with nulls).

**Core Principle**: **"Fill gaps, don't erase" - Accumulate data, never lose it**

### Key Goals

1. **Never regress** - Don't replace `plot = "..."` with `plot = null`
2. **Accumulate data** - Fill gaps over time, increase completeness
3. **Prioritize stale items** - Enrich never-enriched and oldest items first
4. **Graceful degradation** - Rate-limited providers don't block enrichment
5. **Simplicity** - Simple per-field update rules, no complex state machines
6. **Scheduled enrichment** - Daily job enriches 100 oldest/incomplete items

### Problem Statement

**Current Issues**:
- OMDB provider implemented but not integrated into enrichment
- No multi-provider metadata merging (only TMDB used)
- Rate limit failures block entire enrichment job
- No mechanism to prevent data loss when providers return empty values
- No completeness tracking or staleness-based prioritization

**Example Scenario - The Regression Problem**:
```
Database: plot = "A computer hacker learns from mysterious rebels..."
Provider returns: plot = null (rate-limited or empty response)
Current behavior: Overwrites plot with null â†’ DATA LOSS
Desired behavior: Keeps existing plot â†’ NO REGRESSION
```

**Example Scenario - The Staleness Problem**:
```
1000 movies in library:
- 500 movies: Enriched 2 days ago (fresh)
- 300 movies: Enriched 60 days ago (stale)
- 200 movies: Never enriched

Current behavior: enrichALL processes all 1000 randomly
Desired behavior: Prioritize never-enriched, then stale, skip fresh
```

---

## Architecture Design

### High-Level Flow

```
ScheduledJob: enrichALL (daily at 2am)
  â”‚
  â”œâ”€ Query enrichment queue (100 oldest/incomplete items)
  â”‚   â”œâ”€ Never enriched first
  â”‚   â”œâ”€ Oldest enriched second
  â”‚   â””â”€ Least complete third
  â”‚
  â”œâ”€ For each entity:
  â”‚   â”‚
  â”‚   â”œâ”€ Fetch from ALL enabled providers (parallel)
  â”‚   â”‚   â”œâ”€ Provider A: Success â†’ metadata
  â”‚   â”‚   â”œâ”€ Provider B: RateLimitError â†’ skip gracefully
  â”‚   â”‚   â””â”€ Provider C: Success â†’ metadata
  â”‚   â”‚
  â”‚   â”œâ”€ Aggregate responses (provider priority: OMDB > TMDB > Fanart)
  â”‚   â”‚
  â”‚   â”œâ”€ Apply "fill gaps, don't erase" logic per field
  â”‚   â”‚   â”œâ”€ Current null + New value â†’ UPDATE (fill gap)
  â”‚   â”‚   â”œâ”€ Current value + New null â†’ SKIP (prevent regression)
  â”‚   â”‚   â””â”€ Current value + New different value â†’ UPDATE (allow changes)
  â”‚   â”‚
  â”‚   â”œâ”€ Update database (respect field locks)
  â”‚   â”‚
  â”‚   â”œâ”€ Calculate completeness % (filled fields / expected fields)
  â”‚   â”‚
  â”‚   â””â”€ Trigger player sync if significant fields changed
  â”‚
  â””â”€ Repeat for next 99 items
```

### Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EnrichmentScheduler                            â”‚
â”‚  - Runs daily at 2am                            â”‚
â”‚  - Queries staleness-based queue                â”‚
â”‚  - Enqueues 100 jobs                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EnrichmentService                              â”‚
â”‚  - Fetches from all providers                   â”‚
â”‚  - Aggregates with provider priority            â”‚
â”‚  - Applies "fill gaps" logic                    â”‚
â”‚  - Updates completeness tracking                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼           â–¼           â–¼
   ProviderA   ProviderB   ProviderC
   (OMDB)      (TMDB)      (Fanart)
        â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProviderCacheOrchestrator                      â”‚
â”‚  - Manages per-provider caching                 â”‚
â”‚  - 7-day TTL for all providers                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Features

### 1. "Fill Gaps, Don't Erase" Update Logic

**Per-Field Decision Algorithm**:

```typescript
function shouldUpdateField(currentValue: any, newValue: any, fieldLocked: boolean): boolean {
  // User locked this field - never update
  if (fieldLocked) {
    return false;
  }

  // Current is empty â†’ accept any non-empty value (FILL GAP)
  if (currentValue == null || currentValue === '') {
    return newValue != null && newValue !== '';
  }

  // Current has value, new is empty â†’ REJECT (PREVENT REGRESSION)
  if (newValue == null || newValue === '') {
    return false;
  }

  // Both have values â†’ allow update if different (ALLOW CHANGES)
  return currentValue !== newValue;
}
```

**Examples**:

| Current Value | New Value | Locked | Action | Reason |
|---------------|-----------|--------|--------|--------|
| `null` | `"A computer hacker..."` | No | âœ… Update | Fill gap |
| `"A computer hacker..."` | `null` | No | âŒ Skip | Prevent regression |
| `8.7` | `8.8` | No | âœ… Update | Allow change |
| `"The Matrix"` | `"The Matrix"` | No | âŒ Skip | No change |
| `"User edit"` | `"New value"` | Yes | âŒ Skip | Locked field |

### 2. Completeness Tracking

**Calculate after each enrichment**:

```typescript
const EXPECTED_FIELDS = [
  'title', 'plot', 'tagline', 'imdb_rating', 'release_date',
  'runtime', 'certification', 'genres', 'studios', 'poster_url'
];

function calculateCompleteness(movie: Movie): number {
  const filledFields = EXPECTED_FIELDS.filter(field =>
    movie[field] != null && movie[field] !== ''
  );

  return Math.round((filledFields.length / EXPECTED_FIELDS.length) * 100);
}
```

**Store in database**:

```typescript
{
  id: 123,
  title: "The Matrix",
  plot: "A computer hacker...",
  imdb_rating: 8.7,
  // ... other fields

  completeness_pct: 80,  // 8/10 fields filled
  last_enrichment_date: '2025-01-17T14:30:00Z'
}
```

### 3. Staleness-Based Enrichment Queue

**Priority Queue Logic**:

```typescript
async function getEnrichmentQueue(limit: number): Promise<Movie[]> {
  return await db.query(`
    SELECT
      id,
      title,
      last_enrichment_date,
      completeness_pct
    FROM movies
    WHERE monitored = 1
    ORDER BY
      last_enrichment_date ASC NULLS FIRST,  -- Never enriched first
      completeness_pct ASC,                   -- Then least complete
      id ASC                                  -- Tie-breaker
    LIMIT ?
  `, [limit]);
}
```

**Ensures**:
- Never-enriched items processed first
- Oldest enrichments next
- Least complete items prioritized
- Recently enriched items skipped (won't appear in top 100)

### 4. Scheduled Daily Enrichment

**Cron Job** (runs at 2am daily):

```typescript
// Schedule: 0 2 * * * (2am every day)
async function enrichALL() {
  logger.info('Starting scheduled enrichALL');

  const BATCH_SIZE = 100;
  const queue = await getEnrichmentQueue(BATCH_SIZE);

  logger.info(`Enriching ${queue.length} movies (oldest/incomplete)`);

  for (const movie of queue) {
    logger.info(`Enriching: ${movie.title} (last: ${movie.last_enrichment_date || 'never'}, completeness: ${movie.completeness_pct}%)`);

    await enrichMovie(movie.id);

    // Rate-limit friendly: 1 request per second
    await sleep(1000);
  }

  logger.info(`Enrichment complete: ${queue.length} movies processed`);
}
```

**Behavior**:
- Processes 100 items per day (~3,000 per month)
- Never-enriched items go first
- Stale items (>30 days) eventually re-enriched
- Fresh items (<7 days) automatically skipped (won't be in queue)
- Provider caching reduces API calls further

### 5. Provider Priority (Simple)

**Hardcoded priority order** (can be UI-configurable in future):

```typescript
const PROVIDER_PRIORITY = ['omdb', 'tmdb', 'fanart'];

function aggregateMetadata(responses: ProviderResponse[]): Metadata {
  const result = {};

  for (const field of ALL_FIELDS) {
    for (const providerId of PROVIDER_PRIORITY) {
      const value = responses.find(r => r.provider === providerId)?.[field];

      if (value != null && value !== '') {
        result[field] = value;
        break;  // Found value, move to next field
      }
    }
  }

  return result;
}
```

**Priority Rationale**:
- **OMDB first**: Authoritative IMDb ratings, RT scores, Metacritic
- **TMDB second**: Comprehensive metadata, good plot text
- **Fanart third**: High-quality images (when metadata providers lack them)

### 6. Graceful Provider Failures

**Handle rate limits and errors gracefully**:

```typescript
async function enrichMovie(movieId: number) {
  // Fetch from ALL providers (some may fail)
  const responses = await Promise.allSettled(
    providers.map(p => p.fetchMetadata({ movieId }))
  );

  // Extract successful responses only
  const successful = responses
    .filter(r => r.status === 'fulfilled' && r.value != null)
    .map(r => r.value);

  // If ALL providers failed, skip this movie
  if (successful.length === 0) {
    logger.warn(`All providers failed for movie ${movieId}, skipping`);
    return { updated: false, reason: 'all_providers_failed' };
  }

  // Continue with whatever data we have
  const aggregated = aggregateMetadata(successful);

  // Apply "fill gaps, don't erase" logic
  const updates = buildUpdates(movieId, aggregated);

  if (Object.keys(updates).length > 0) {
    await db.movies.update(movieId, updates);
    await updateCompleteness(movieId);

    // Trigger player sync if significant fields changed
    if (hasSignificantChanges(updates)) {
      await jobQueue.enqueue('player-sync', { movieId });
    }
  }

  return { updated: true, changedFields: Object.keys(updates) };
}
```

**Benefits**:
- Rate-limited providers don't block enrichment
- Partial data is better than no data
- System degrades gracefully (OMDB down â†’ TMDB still works)
- No alerts to user (rate limits are temporary, logged for debugging)

---

## Database Schema Changes

### Minimal Schema Updates

```sql
-- Add completeness and enrichment tracking to movies
ALTER TABLE movies ADD COLUMN completeness_pct INTEGER DEFAULT 0;
ALTER TABLE movies ADD COLUMN last_enrichment_date TIMESTAMP;

-- Same for series
ALTER TABLE series ADD COLUMN completeness_pct INTEGER DEFAULT 0;
ALTER TABLE series ADD COLUMN last_enrichment_date TIMESTAMP;

-- Index for staleness queue
CREATE INDEX idx_movies_enrichment_queue ON movies(
  monitored,
  last_enrichment_date ASC NULLS FIRST,
  completeness_pct ASC
);

CREATE INDEX idx_series_enrichment_queue ON series(
  monitored,
  last_enrichment_date ASC NULLS FIRST,
  completeness_pct ASC
);
```

**No other tables needed**. We're keeping this simple:
- No field authorities table (hardcoded priority)
- No source tracking (not needed for "fill gaps" logic)
- No enrichment history log (can add later if needed)

---

## API Changes

### Enhanced Endpoints

#### 1. Manual Enrichment (Updated)

```
POST /api/movies/:id/enrich
```

**Request**:
```json
{
  "forceRefresh": true  // Bypass cache
}
```

**Response**:
```json
{
  "success": true,
  "changedFields": ["imdb_rating", "plot"],
  "completeness": 90,  // NEW: Completeness after enrichment
  "previousCompleteness": 80,  // NEW: Before enrichment
  "providers": {
    "successful": ["omdb", "tmdb"],
    "rateLimited": [],
    "failed": []
  }
}
```

#### 2. Completeness Report (NEW)

```
GET /api/movies/completeness
```

**Response**:
```json
{
  "summary": {
    "total": 1000,
    "complete": 650,      // 100% completeness
    "partial": 300,       // 50-99% completeness
    "minimal": 50,        // < 50% completeness
    "avgCompleteness": 87
  },
  "topIncomplete": [
    {
      "id": 456,
      "title": "Inception",
      "completeness": 60,
      "missingFields": ["tagline", "awards", "certification", "outline"]
    }
  ]
}
```

#### 3. Enrichment Queue Status (NEW)

```
GET /api/enrichment/queue
```

**Response**:
```json
{
  "nextEnrichment": "2025-11-22T02:00:00Z",
  "queueSize": 100,
  "topItems": [
    {
      "id": 123,
      "title": "The Matrix",
      "lastEnriched": null,  // Never enriched
      "completeness": 40,
      "priority": 1
    },
    {
      "id": 456,
      "title": "Inception",
      "lastEnriched": "2024-10-15T10:00:00Z",  // 97 days ago
      "completeness": 85,
      "priority": 2
    }
  ]
}
```

---

## UI Requirements

### 1. Completeness Dashboard (NEW)

**Location**: Dashboard â†’ Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Library Completeness                            [View Details]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Overall Completeness: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 87%                        â”‚
â”‚                                                               â”‚
â”‚  Complete (100%):     650 movies                             â”‚
â”‚  Partial (50-99%):    300 movies                             â”‚
â”‚  Minimal (<50%):       50 movies                             â”‚
â”‚                                                               â”‚
â”‚  Next Enrichment: Tomorrow at 2:00 AM (100 items)           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Movie Detail - Enrichment Status (Enhanced)

**Location**: Movie Detail â†’ Metadata Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metadata                          [Refresh Metadata (Force)] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚ Completeness: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80% (8/10 fields)                  â”‚
â”‚ Last Enriched: 2 days ago                                    â”‚
â”‚                                                               â”‚
â”‚ Missing Fields:                                               â”‚
â”‚   â€¢ Tagline (waiting for TMDB)                               â”‚
â”‚   â€¢ Awards (waiting for OMDB)                                â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Title:       The Matrix            ðŸ”’ (User locked)   â”‚   â”‚
â”‚ â”‚ Plot:        A computer hacker...                      â”‚   â”‚
â”‚ â”‚ IMDb Rating: 8.7                                       â”‚   â”‚
â”‚ â”‚ Tagline:     [Missing]                                 â”‚   â”‚
â”‚ â”‚ Awards:      [Missing]                                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Enrichment Queue Viewer (NEW)

**Location**: Settings â†’ Enrichment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Enrichment Queue (Next 100 Items)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚ Next Run: Tomorrow at 2:00 AM                                â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ #  â”‚ Title          â”‚ Last Enriched â”‚ Complete â”‚      â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚   â”‚
â”‚ â”‚ 1  â”‚ The Matrix     â”‚ Never         â”‚ 40%      â”‚ â–‘â–‘â–‘â–‘ â”‚   â”‚
â”‚ â”‚ 2  â”‚ Inception      â”‚ 97 days ago   â”‚ 85%      â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚
â”‚ â”‚ 3  â”‚ Interstellar   â”‚ Never         â”‚ 50%      â”‚ â–‘â–‘â–‘â–‘ â”‚   â”‚
â”‚ â”‚ ...â”‚                â”‚               â”‚          â”‚      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚ [Run Now (Process 100)]  [Skip Queue]                        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Phases

### Phase 1: Core "Fill Gaps" Logic (Week 1)

**Tasks**:
1. Implement `shouldUpdateField()` function
2. Implement `calculateCompleteness()` function
3. Add database columns (`completeness_pct`, `last_enrichment_date`)
4. Update `EnrichmentService.enrichMovie()` to use new logic
5. Unit tests for field update rules

**Deliverables**:
- `src/services/enrichment/FieldUpdateLogic.ts`
- Migration: `20251121_002_completeness_tracking.ts`
- Tests: `FieldUpdateLogic.test.ts`

**Success Criteria**:
- âœ… Null never overwrites value
- âœ… Value updates when different
- âœ… Locked fields skipped
- âœ… Completeness calculated correctly

---

### Phase 2: Staleness Queue & Scheduling (Week 1)

**Tasks**:
1. Implement `getEnrichmentQueue()` function
2. Create `enrichALL()` scheduled job
3. Add cron scheduling (2am daily)
4. Update enrichment to track `last_enrichment_date`
5. Integration tests for queue priority

**Deliverables**:
- `src/services/enrichment/EnrichmentScheduler.ts`
- `src/services/jobs/enrichALL.ts`
- Tests: `EnrichmentQueue.test.ts`

**Success Criteria**:
- âœ… Never-enriched items first
- âœ… Oldest items next
- âœ… Fresh items skipped
- âœ… Job runs on schedule

---

### Phase 3: OMDB Integration (Week 2)

**Tasks**:
1. Wire OMDB into `ProviderCacheOrchestrator`
2. Add OMDB to provider priority list
3. Test OMDB field mapping (ratings, awards, outline)
4. Update enrichment flow to query OMDB
5. Integration tests with OMDB + TMDB

**Deliverables**:
- Enhanced `ProviderCacheOrchestrator.fetchFromAllProviders()`
- OMDB provider tests

**Success Criteria**:
- âœ… OMDB queried during enrichment
- âœ… IMDb ratings populated
- âœ… RT/Metacritic scores populated
- âœ… Awards field populated
- âœ… OMDB rate limits handled gracefully

---

### Phase 4: UI Implementation (Week 2)

**Tasks**:
1. Completeness dashboard widget
2. Movie detail enrichment status
3. Enrichment queue viewer
4. Missing fields display
5. Manual force refresh button

**Deliverables**:
- `public/frontend/src/components/CompletnessDashboard.tsx`
- `public/frontend/src/components/EnrichmentQueue.tsx`
- Enhanced movie detail metadata tab

**Success Criteria**:
- âœ… Users see completeness %
- âœ… Users see missing fields
- âœ… Users see enrichment queue
- âœ… Force refresh works

---

### Phase 5: Testing & Polish (Week 3)

**Tasks**:
1. Performance testing (1,000+ movies)
2. Provider failure simulation tests
3. Documentation updates
4. UI polish and loading states
5. Monitoring/logging enhancements

**Deliverables**:
- Performance benchmarks
- Updated documentation
- Production-ready code

**Success Criteria**:
- âœ… 1,000 movies enriched in <2 hours
- âœ… Provider failures don't break system
- âœ… Completeness tracking accurate
- âœ… Docs updated

---

## Testing Strategy

### Unit Tests

**Key Suites**:

1. **Field Update Logic** (`FieldUpdateLogic.test.ts`)
   ```typescript
   describe('shouldUpdateField', () => {
     it('fills gaps (null â†’ value)', () => {
       expect(shouldUpdateField(null, 'value', false)).toBe(true);
     });

     it('prevents regression (value â†’ null)', () => {
       expect(shouldUpdateField('value', null, false)).toBe(false);
     });

     it('allows changes (value1 â†’ value2)', () => {
       expect(shouldUpdateField('old', 'new', false)).toBe(true);
     });

     it('respects locks', () => {
       expect(shouldUpdateField('old', 'new', true)).toBe(false);
     });
   });
   ```

2. **Completeness Calculation** (`Completeness.test.ts`)
   ```typescript
   describe('calculateCompleteness', () => {
     it('calculates correctly', () => {
       const movie = {
         title: 'The Matrix',
         plot: 'A hacker...',
         imdb_rating: 8.7,
         tagline: null,  // Missing
         awards: null    // Missing
       };

       expect(calculateCompleteness(movie)).toBe(60); // 3/5 = 60%
     });
   });
   ```

3. **Enrichment Queue** (`EnrichmentQueue.test.ts`)
   ```typescript
   describe('getEnrichmentQueue', () => {
     it('prioritizes never-enriched', async () => {
       const queue = await getEnrichmentQueue(10);
       expect(queue[0].last_enrichment_date).toBe(null);
     });

     it('orders by staleness', async () => {
       const queue = await getEnrichmentQueue(10);
       const dates = queue.map(m => m.last_enrichment_date);
       expect(dates).toEqual(dates.sort());
     });
   });
   ```

### Integration Tests

**Critical Scenarios**:

1. **Multi-Provider Enrichment**
   - All providers succeed â†’ metadata merged correctly
   - OMDB rate-limited â†’ TMDB fills gaps
   - All providers fail â†’ movie skipped gracefully

2. **Completeness Tracking**
   - Initial enrichment: 0% â†’ 80%
   - Subsequent enrichment: 80% â†’ 100% (gaps filled)
   - Provider failure: 100% â†’ 100% (no regression)

3. **Scheduled Job**
   - Queue prioritizes correctly
   - Job processes 100 items
   - Fresh items not re-enriched

### Manual Testing

**Scenarios**:

1. **Completeness Dashboard**
   - Displays overall stats correctly
   - Shows top incomplete movies
   - Updates after enrichment

2. **Force Refresh**
   - Button triggers immediate enrichment
   - Completeness updates
   - Missing fields filled

3. **Provider Failures**
   - Simulate OMDB rate limit
   - Verify TMDB still works
   - Check completeness doesn't regress

---

## Success Criteria

### Functional Requirements

- âœ… Never regress (value â†’ null never happens)
- âœ… Fill gaps over time
- âœ… Completeness tracking accurate
- âœ… Staleness queue prioritizes correctly
- âœ… OMDB integrated into enrichment
- âœ… Provider failures don't break system
- âœ… Scheduled job runs daily

### Performance Requirements

- âœ… 1,000 movies enriched in < 2 hours
- âœ… Completeness calculation < 10ms per movie
- âœ… Queue query < 100ms
- âœ… Provider caching reduces API calls by 80%+

### User Experience Requirements

- âœ… Users see completeness %
- âœ… Users see missing fields
- âœ… Users understand enrichment priority
- âœ… Force refresh works instantly
- âœ… No data loss during provider failures

---

## Rollback Plan

### Phase 1-2 (Core Logic)
- **Rollback**: Revert migration, remove new functions
- **Impact**: None (no user-facing changes)

### Phase 3 (OMDB Integration)
- **Rollback**: Disable OMDB in provider list
- **Impact**: Enrichment works with TMDB only

### Phase 4 (UI)
- **Rollback**: Revert frontend changes
- **Impact**: Completeness UI removed, core logic still works

### Phase 5 (Polish)
- **Rollback**: N/A (bug fixes only)

---

## Documentation Updates Required

### User Documentation

1. **Getting Started** - Add completeness tracking explanation
2. **Configuration** - Explain enrichment scheduling
3. **Troubleshooting** - Provider failure handling

### Developer Documentation

1. **Architecture** - Document "fill gaps" logic
2. **Enrichment** - Update enrichment flow diagrams
3. **Providers** - Add OMDB integration details

---

## Open Questions

*To be resolved during implementation:*

1. **Completeness calculation**: Should some fields be weighted more than others?
2. **Queue size**: Is 100 items/day the right batch size?
3. **Staleness threshold**: Should we force re-enrichment after N days?
4. **Provider priority**: Should this be UI-configurable or hardcoded?

---

**End of Specification**
