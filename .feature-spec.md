# Feature Specification: Provider Page Redesign

**Branch**: `feature/provider-page-redesign`
**Status**: Planning
**Last Updated**: 2025-11-22

---

## Overview

Redesign the Settings â†’ Providers page to use a static presentation model (similar to Mediaâ†’Moviesâ†’Metadata tab) instead of the current modal-based "add provider" workflow. All providers should be visible with inline configuration, eliminating the need for multiple modals and improving discoverability.

---

## Current State Analysis

### Current Implementation
- **Location**: `/public/frontend/src/pages/settings/Providers.tsx`
- **Pattern**: Three separate tabs (Providers, Asset Selection, Metadata Selection)
- **Workflow**: Modal-based provider addition
  1. Click "Add Provider" card
  2. Modal lists disabled providers
  3. Click provider â†’ opens configuration modal
  4. Configure API key, language, region
  5. Test connection â†’ Save

### Current Components
- `ProviderCardCompact` - Shows enabled providers as cards
- `AddProviderCard` - Button to trigger add modal
- `ProviderConfigModal` - Edit provider settings
- `AddProviderModal` - Select provider to enable
- `AssetTypePriorityConfig` - Drag-drop asset priorities
- `MetadataFieldPriorityConfig` - Drag-drop metadata priorities

### Pain Points
âŒ Indirect workflow (multiple modals)
âŒ Hidden providers (disabled providers not visible)
âŒ Disconnected tabs (configuration, assets, metadata feel separate)
âŒ Poor discoverability (users don't know what providers exist)

---

## Goals

### User Experience Goals
âœ… **Scannable**: All providers visible at a glance
âœ… **Inline**: Configuration without modals
âœ… **Consistent**: Match MetadataTab TabSection pattern
âœ… **Efficient**: Fewer clicks to enable/configure providers
âœ… **Clear**: Status and capabilities immediately visible

### Technical Goals
âœ… **Reuse**: Leverage existing UI components
âœ… **Performance**: Optimize with caching and lazy loading
âœ… **Accessibility**: Full keyboard navigation and screen reader support
âœ… **Maintainability**: Clean component hierarchy

---

## Architecture

### Page Structure

**Decision**: Single-page layout with collapsible sections (no tabs)

```
Settings â†’ Providers
â”‚
â”œâ”€ Provider Configuration Section
â”‚  â”œâ”€ TMDB (expanded - enabled)
â”‚  â”œâ”€ Fanart.tv (expanded - enabled)
â”‚  â”œâ”€ OMDB (collapsed - enabled)
â”‚  â”œâ”€ TVDB (collapsed - disabled)
â”‚  â””â”€ IMDb (collapsed - disabled)
â”‚
â”œâ”€ Asset Selection Strategy (collapsible)
â”‚  â”œâ”€ Mode: Balanced / Custom
â”‚  â””â”€ Custom priority configuration (when mode = custom)
â”‚
â””â”€ Metadata Field Priority (collapsible)
   â”œâ”€ Mode: Balanced / Custom
   â””â”€ Custom priority configuration (when mode = custom)
```

**Rationale**:
- Single context (no tab switching)
- Better progressive disclosure
- Follows Settings page convention
- All related settings visible on scroll

### Provider Presentation

**Pattern**: Accordion-style expandable cards

**Enabled Provider** (Expanded):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ TMDB                          [ON] [â–²]          â”‚
â”‚ Movies â€¢ TV Shows                                   â”‚
â”‚ Provides: Posters, Fanart, Trailers                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API Key (optional)                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (masked)                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â„¹ Using embedded default key. Get your own API    â”‚
â”‚   key to track usage â†’ [Get API Key â†’]            â”‚
â”‚                                                     â”‚
â”‚ Language: [English â–¼]  Region: [US â–¼]             â”‚
â”‚                                                     â”‚
â”‚ Rate Limit: 40 requests per 10 seconds             â”‚
â”‚                                                     â”‚
â”‚ [Test Connection]  [Save]  [Disable]               â”‚
â”‚ âœ“ Connection Successful                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Disabled Provider** (Collapsed):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ TVDB                         [OFF] [â–¼]          â”‚
â”‚ TV Shows                                            â”‚
â”‚ Provides: Posters, Banners, Episode Stills         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interaction Flow**:
1. Disabled provider shows collapsed with gray styling
2. Click toggle â†’ provider expands, showing configuration fields
3. Edit fields â†’ auto-save on blur (debounced 500ms)
4. Test connection â†’ inline status display
5. Click toggle again â†’ disable provider with confirmation

### Configuration Workflow

**Auto-Save Pattern**:
- No explicit "Save" button for simple fields
- Changes saved automatically on field blur
- Debounced to prevent excessive API calls (500ms)
- Optimistic updates with rollback on error
- Toast notifications for success/failure

**Validation**:
- Required fields validated on blur
- Test connection validates API key
- Disable action requires confirmation dialog

---

## Component Architecture

### New Components

#### 1. `ProvidersPage` (Main Page)
**Purpose**: Container orchestrating the entire provider management interface

**Props**: None (fetches data via hooks)

**Structure**:
```typescript
<div className="space-y-3">
  <PageHeader title="Provider Configuration" />

  <TabSection title="Providers">
    <ProviderList providers={providers} />
  </TabSection>

  <TabSection title="Asset Selection Strategy" collapsible>
    <AssetSelectionSection />
  </TabSection>

  <TabSection title="Metadata Field Priority" collapsible>
    <MetadataFieldPrioritySection />
  </TabSection>
</div>
```

#### 2. `ProviderAccordionCard` (Provider Display)
**Purpose**: Expandable card for each provider with inline configuration

**Props**:
```typescript
interface ProviderAccordionCardProps {
  provider: ProviderWithMetadata;
  isExpanded: boolean;
  onToggleExpand: () => void;
  onUpdate: (updates: UpdateProviderRequest) => Promise<void>;
  onTest: () => Promise<TestProviderResponse>;
  onDisable: () => Promise<void>;
}
```

**Features**:
- Header always visible (name, toggle, status)
- Configuration form visible when expanded
- Auto-save on field blur
- Inline test connection with status display
- Loading states for async operations

#### 3. `ProviderList` (Container)
**Purpose**: Groups providers into enabled/disabled sections

**Props**:
```typescript
interface ProviderListProps {
  providers: ProviderWithMetadata[];
  expandedProviderId: string | null;
  onExpandProvider: (providerId: string) => void;
}
```

**Layout**:
- Enabled providers section (expanded by default)
- Disabled providers section (collapsed by default)
- Empty states for each section

#### 4. `ProviderConfigForm` (Inline Form)
**Purpose**: Reusable form for provider settings

**Props**:
```typescript
interface ProviderConfigFormProps {
  provider: ProviderWithMetadata;
  values: ProviderConfigValues;
  onChange: (field: string, value: string) => void;
  onTest: () => Promise<TestProviderResponse>;
  onSave: () => Promise<void>;
  isDirty: boolean;
  testResult: TestProviderResponse | null;
  isLoading: boolean;
}
```

**Fields**:
- API Key input (with visibility toggle)
- Personal API Key (optional)
- Language select (provider-specific)
- Region select (provider-specific)
- Rate limit info (read-only)
- Action buttons (Test, Save, Disable)

### Reused Components

**Keep As-Is**:
- `TabSection` - Section wrapper with header
- `AssetTypePriorityConfig` - Asset priority configuration
- `MetadataFieldPriorityConfig` - Metadata field priority
- `ProviderCoverageStatus` - Coverage indicator
- `Card`, `Button`, `Input`, `Select`, `Switch` - UI primitives
- `AnimatedTabs` - Tab navigation (if needed for legacy support)

**Remove**:
- `ProviderConfigModal` - Replaced by inline accordion
- `AddProviderModal` - No longer needed (all providers visible)
- `AddProviderCard` - No longer needed

---

## Backend Changes

### Required Changes

#### 1. Add Usage Statistics to Provider Response

**Endpoint**: `GET /api/providers`

**Enhancement**:
```typescript
interface EnhancedProviderResponse {
  config: ProviderConfig;
  metadata: ProviderMetadata;
  statistics?: {
    totalAssetsFetched: number;
    lastSuccessfulFetch?: Date;
    assetsByType: Record<string, number>;
  };
  health?: {
    healthy: boolean;
    circuitState: string;
    rateLimitRemaining: number;
  };
}
```

**Rationale**: Display provider usage stats in UI

**Complexity**: Medium (requires aggregation queries)

**Breaking Changes**: None (additive)

#### 2. Add PATCH Endpoint

**Endpoint**: `PATCH /api/providers/:name`

**Purpose**: Better semantics for partial updates (inline editing)

**Complexity**: Low (reuse existing update logic)

**Breaking Changes**: None (POST still works)

#### 3. Response Caching

**Implementation**: In-memory cache with 60-second TTL

**Rationale**: Reduce database queries for frequently accessed provider list

**Complexity**: Low

**Breaking Changes**: None (transparent)

### Optional Enhancements

- Batch update endpoint (`PATCH /api/providers/batch`)
- Separate statistics endpoint (`GET /api/providers/statistics`)

### Database

**No schema changes needed** - existing `provider_config` table has all required fields.

---

## State Management

### Global State (TanStack Query)

```typescript
// Provider list
const { data: providers } = useProviders();
// Cache key: ['providers']
// Invalidate on: update, enable, disable

// Auto-selection config
const { data: config } = useDataSelectionConfig();
// Cache key: ['data-selection-config']
```

### Local State (Component)

```typescript
// Accordion expansion state
const [expandedProviders, setExpandedProviders] = useState<Set<string>>(
  new Set(enabledProviderIds)
);

// Form values (optimistic updates)
const [localConfig, setLocalConfig] = useState(provider.config);

// Test results
const [testResult, setTestResult] = useState<TestResult | null>(null);
```

### Optimistic Updates

```typescript
const updateProvider = useMutation({
  onMutate: async (variables) => {
    // 1. Cancel outgoing queries
    await queryClient.cancelQueries(['providers']);

    // 2. Snapshot current state
    const previous = queryClient.getQueryData(['providers']);

    // 3. Optimistically update cache
    queryClient.setQueryData(['providers'], (old) =>
      updateProviderInList(old, variables)
    );

    return { previous };
  },
  onError: (err, variables, context) => {
    // Rollback on error
    queryClient.setQueryData(['providers'], context.previous);
    toast.error('Failed to update provider');
  },
  onSettled: () => {
    queryClient.invalidateQueries(['providers']);
  }
});
```

---

## Design Principles

### 1. Consistency with MetadataTab
- Use TabSection component pattern
- Inline editing with auto-save
- Status badges for connection state
- Clean card layout with consistent spacing

### 2. Progressive Disclosure
- Collapsed by default for disabled providers
- Expanded by default for enabled providers
- Hide advanced options until needed
- Show only relevant fields per provider

### 3. Scanability
**Visual Hierarchy**:
1. Enabled providers - full color, expanded
2. Disabled providers - grayed out, collapsed
3. Status badges - green (success), red (error), gray (untested)

**Information Density**:
- High: All providers visible
- Medium: Configuration for enabled providers
- Low: Priority configuration (collapsed sections)

### 4. Accessibility
- ARIA labels for all interactive elements
- Keyboard navigation (Tab, Enter, Escape)
- Focus management on expand/collapse
- Screen reader announcements for state changes

---

## Implementation Plan

### Phase 1: Core Structure (4-6 hours)
1. Create `ProvidersPage` component
2. Implement `ProviderAccordionCard` with basic structure
3. Create `ProviderList` container
4. Wire up state management (TanStack Query hooks)
5. Test basic expand/collapse functionality

**Deliverable**: Provider list with accordion behavior

### Phase 2: Inline Configuration (4-6 hours)
1. Implement `ProviderConfigForm` component
2. Add auto-save functionality with debouncing
3. Add optimistic updates with rollback
4. Implement test connection inline
5. Add loading and error states

**Deliverable**: Fully functional inline configuration

### Phase 3: Backend Enhancements (3-4 hours)
1. Add usage statistics to provider response
2. Add PATCH endpoint for partial updates
3. Implement response caching
4. Update API client methods

**Deliverable**: Enhanced API with statistics

### Phase 4: Priority Integration (2-3 hours)
1. Move `AssetSelectionSection` into main page
2. Move `MetadataFieldPrioritySection` into main page
3. Integrate with provider enable/disable logic
4. Test priority dropdown filtering

**Deliverable**: Unified provider management page

### Phase 5: Polish & Testing (3-4 hours)
1. Add keyboard navigation
2. Add ARIA labels and screen reader support
3. Implement empty states
4. Mobile responsive design
5. Manual testing in browser
6. Write/update component tests

**Deliverable**: Production-ready feature

### Phase 6: Cleanup (1-2 hours)
1. Remove deprecated components
2. Update routing if needed
3. Update documentation
4. Delete feature spec before merge

**Total Estimated Time**: 17-25 hours

---

## Testing Strategy

### Unit Tests
- Component rendering with various provider states
- Auto-save debouncing logic
- Optimistic update rollback
- Form validation

### Integration Tests
- Provider enable/disable flow
- Configuration save and reload
- Test connection workflow
- Priority configuration interaction

### Manual Testing
- Keyboard navigation
- Screen reader testing
- Mobile responsive design
- Error handling scenarios
- Loading states

### Browser Testing
- Chrome, Firefox, Edge (latest)
- Mobile Safari (iOS)
- Mobile Chrome (Android)

---

## Documentation Updates

### Files to Update
- `docs/getting-started/CONFIGURATION.md` - Provider setup instructions
- `docs/providers/OVERVIEW.md` - Provider configuration workflow
- `docs/frontend/COMPONENTS.md` - New components documentation

### Screenshots
- Update provider page screenshots
- Create GIFs demonstrating inline configuration
- Update getting started guide visuals

---

## Success Criteria

### Must-Have
âœ… All providers visible (enabled + disabled)
âœ… Inline configuration without modals
âœ… Auto-save functionality working
âœ… Test connection inline
âœ… Keyboard navigation functional
âœ… Mobile responsive
âœ… No TypeScript errors
âœ… All tests passing

### Should-Have
âœ… ARIA labels and screen reader support
âœ… Loading skeletons
âœ… Empty states
âœ… Usage statistics displayed
âœ… Optimistic updates with rollback

### Nice-to-Have
âšª Drag-and-drop priority reordering
âšª Bulk enable/disable
âšª Provider search/filter
âšª Advanced mode toggle

---

## Risks & Mitigations

### Risk 1: Performance with Statistics Queries
**Mitigation**: Implement response caching, consider separate statistics endpoint if needed

### Risk 2: Complex State Management
**Mitigation**: Use TanStack Query for server state, local state only for UI

### Risk 3: Breaking Existing Workflows
**Mitigation**: Maintain backward compatibility, comprehensive testing

### Risk 4: Accessibility Gaps
**Mitigation**: Follow ARIA best practices, test with screen readers

---

## Future Enhancements (Not in Scope)

- Provider setup wizard (multi-step modal)
- Bulk API key import
- Provider health monitoring dashboard
- Per-library provider configuration
- Custom provider plugins
- Drag-and-drop priority reordering
- Provider search/filter
- Change history/audit log

---

## Approval Required

This feature specification requires approval before implementation. Please review and provide feedback on:
1. Overall architecture approach
2. Component design decisions
3. Backend changes required
4. Implementation timeline
5. Success criteria

**Waiting for approval to proceed with implementation.**
