# Feature: OMDB API Key Configuration & Test Connection

**Status**: Planning → Implementation
**Branch**: feature/omdb-enhancements
**Created**: 2025-11-21
**Agents Consulted**: Morgan (Technical Architect)

---

## User Goal

Enable users to configure and test OMDB API keys through the Settings UI, fixing the critical bug that prevents OMDB provider from functioning. Currently, users cannot test their OMDB API keys, resulting in a 501 "not implemented" error, which blocks OMDB data from populating during enrichment.

## Scope

**In Scope**:
- Add OMDB test connection handler to `providerConfigController.ts`
- Implement `testOMDBConnection()` private method following existing patterns
- Validate API key functionality with test IMDb ID
- Proper error handling (401 for invalid keys, etc.)
- Enable OMDB data population during enrichment once keys are configured

**Out of Scope**:
- Provider aggregation/merging improvements (separate feature)
- Default OMDB API key (not possible - requires user signup)
- Refactoring existing provider test methods
- UI changes (Settings UI already supports provider testing)

---

## Technical Design

### Root Cause Analysis (Morgan)

**Primary Issue**: OMDB is missing from the `testProvider()` switch statement in `providerConfigController.ts` (lines 199-238). When users click "Test Connection" in Settings UI, the controller returns 501 "not implemented".

**Secondary Issue**: Users don't understand that OMDB requires personal API key signup (no default available).

**Architecture Status**:
- ✅ Provider metadata registered correctly (line 147-162 in providerMetadata.ts)
- ✅ Provider implementation complete and functional
- ✅ ProviderRegistry integration working
- ✅ OMDBClient with test capability exists
- ❌ Controller test handler missing (THIS IS THE BUG)

### Backend Changes (Jordan)

**File**: `src/controllers/providerConfigController.ts`

**Changes Required**:

1. **Add OMDB case to switch statement** (after line 225):
```typescript
case 'omdb':
  await this.testOMDBConnection(data.apiKey);
  message = 'Successfully connected to OMDb API';
  break;
```

2. **Add private test method** (after line 571):
```typescript
/**
 * Test OMDb connection
 */
private async testOMDBConnection(apiKey?: string): Promise<void> {
  if (!apiKey) {
    throw new ValidationError(
      'OMDb API key is required',
      {
        service: 'ProviderConfigController',
        operation: 'testOMDBConnection',
        metadata: { provider: 'omdb' }
      }
    );
  }

  const { OMDBClient } = await import('../services/providers/omdb/OMDBClient.js');

  const testClient = new OMDBClient({
    apiKey,
    baseUrl: 'https://www.omdbapi.com',
    timeout: 10000
  });

  // Test API call - get a known movie (The Matrix: tt0133093)
  try {
    await testClient.getById('tt0133093');
  } catch (error) {
    const status = getStatusCode(error);
    if (status === 401) {
      throw new AuthenticationError(
        'Invalid OMDb API key. Please check your credentials at https://www.omdbapi.com/apikey.aspx',
        {
          service: 'ProviderConfigController',
          operation: 'testOMDBConnection',
          metadata: { provider: 'omdb', statusCode: status }
        }
      );
    }
    throw new ProviderError(
      `OMDb API test failed: ${getErrorMessage(error)}`,
      'omdb',
      ErrorCode.PROVIDER_INVALID_RESPONSE,
      500,
      true,
      {
        service: 'ProviderConfigController',
        operation: 'testOMDBConnection',
        metadata: { statusCode: status }
      },
      error instanceof Error ? error : undefined
    );
  }
}
```

**Why This Pattern?**:
- Follows existing TMDB/TVDB/FanArt test patterns (direct client instantiation)
- Uses lightweight test (single movie fetch by IMDb ID)
- Proper error handling with AuthenticationError for 401
- Helpful error message includes signup URL
- Uses known stable IMDb ID (The Matrix: tt0133093)

### UI Changes

**None required** - Settings UI already has provider test functionality via:
- `POST /api/providers/:name/test` endpoint
- Test button on provider cards
- Success/error message display

### Testing Strategy

**Unit Tests** (future enhancement):
- Mock OMDBClient in controller test
- Test successful connection
- Test 401 authentication error
- Test network errors

**Manual Testing** (required before merge):
1. **Invalid API Key**:
   - Navigate to Settings → Providers → OMDb API
   - Enter invalid API key (e.g., "invalid123")
   - Click "Test Connection"
   - Expected: Error message "Invalid OMDb API key. Please check your credentials..."

2. **Valid API Key**:
   - Enter valid OMDB API key
   - Click "Test Connection"
   - Expected: Success message "Successfully connected to OMDb API"
   - Verify `last_test_status` = 'success' in database

3. **Empty API Key**:
   - Leave API key field blank
   - Click "Test Connection"
   - Expected: Validation error "OMDb API key is required"

4. **Enrichment Flow**:
   - Configure valid OMDB API key
   - Enable OMDB provider
   - Run enrichment on a movie
   - Verify OMDB ratings (IMDb, Rotten Tomatoes, Metacritic) populate
   - Check movie detail page for OMDB-sourced fields

---

## Implementation Tasks

**For ROADMAP.md**:

- [x] Root cause analysis (Morgan)
- [ ] Add OMDB case to testProvider switch statement
- [ ] Implement testOMDBConnection private method
- [ ] Manual testing: invalid key scenario
- [ ] Manual testing: valid key scenario
- [ ] Manual testing: enrichment flow with OMDB
- [ ] Update ROADMAP.md with completion

---

## Documentation Updates Required

**None required** - OMDB provider is already fully documented in `docs/providers/OMDB.md` (665 lines), including:
- How to get API keys
- Configuration instructions
- Test connection process
- Rate limits and pricing

---

## Success Criteria

- [ ] Users can test OMDB API keys in Settings UI
- [ ] Invalid keys show proper error message with signup URL
- [ ] Valid keys show success message and update test status
- [ ] OMDB data populates during enrichment after configuration
- [ ] No regressions to existing provider tests (TMDB, TVDB, etc.)

---

## Risks & Mitigations

**Risk**: Users may not understand OMDB requires signup for API key
- **Mitigation**: Error message includes link to https://www.omdbapi.com/apikey.aspx
- **Mitigation**: Provider metadata already shows `apiKeyBenefit` text with signup link

**Risk**: Rate limiting on free tier (1000 requests/day)
- **Mitigation**: Already handled by OMDBClient rate limiter (10 req/15sec)
- **Mitigation**: Documentation explains rate limits thoroughly

**Risk**: Test connection consumes 1 API request
- **Mitigation**: Acceptable - test is optional and uses cached result if retested
- **Mitigation**: Consistent with other providers (TMDB/TVDB also consume requests)

---

## Notes

### Why OMDB Has No Default API Key

Unlike TMDB/TVDB/FanArt.tv which have project-level API keys embedded in Metarr, OMDB requires each user to sign up for their own free API key. This is intentional and matches the pattern used for TheAudioDB.

### Test IMDb ID Choice

Using The Matrix (tt0133093) because:
- Highly stable, won't be removed from OMDB
- Popular movie with complete metadata
- Used in other OMDB examples in codebase
- Fast response time (well-cached by OMDB)

### Future Enhancements (Out of Scope)

After this fix is merged, consider:
1. **Provider Aggregation Improvements**: Enhance how multiple provider data is merged (user's request #3)
2. **Smart API Call Strategy**: Optimize when and how providers are called (user's request #2)
3. **Provider Test Refactoring**: Use BaseProvider.testConnection() instead of direct clients (architectural improvement)
