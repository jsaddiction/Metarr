# Feature: Metadata Completeness - Provider to Database to UI

**Status**: Planning → Implementation → In Progress
**Branch**: feature/metadata-completeness
**Created**: 2025-11-19
**Last Updated**: 2025-11-20
**Agents Consulted**: Morgan (Architect), Casey (Frontend), Jordan (Backend)

## Session Notes

### 2025-11-20 - UI Polish & Layout Refinements

**Completed:**
- Reorganized Production & Stats section into grouped badges (Financial Data, Release Status)
- Wrapped all editable fields in "Base Metadata" section with clear visual grouping
- Renamed "Related Entities" to "Extended Metadata" for clarity
- Added directory path display in MetadataTab header for file identification
- Implemented equal-height TagInput boxes with bottom-aligned Add buttons
- Created multi-column responsive layout for Extended Metadata section (3 cols on desktop)
- Removed unnecessary horizontal rule separators
- Combined Production/Stats and External Links into side-by-side layout on desktop

**UI Improvements:**
- All TagInput components in grid rows now maintain equal height (determined by tallest box)
- Add buttons consistently aligned to bottom-left corner across all TagInput fields
- Clear visual hierarchy: Base Metadata → Extended Metadata → Production/Stats & External Links → Technical Details
- Compact badge design for Production & Stats (Financial Data combines Budget + Revenue, Release Status combines Status + Popularity)
- Responsive grid layouts adapt gracefully from desktop (3 cols) to tablet (2 cols) to mobile (1 col)

**Commits:**
- `a8df39a` - Combined Production & Stats badges into grouped items
- `0f78a23` - Removed horizontal rule separator below header
- `428dd51` - Added directory path display to header
- `770cc71` - Reorganized sections with clear grouping
- `d026d0a` - Combined Production/Stats and External Links in two-column layout
- `e72b01f` - Equalized TagInput heights with bottom-aligned buttons
- `7fdd33d` - Added multi-column layout to Related Entities section
- `50ed5fc` - Optimized MetadataTab layout and spacing

---

## User Goal

User noticed missing metadata in the UI (e.g., "21 Bridges") and identified a gap: we're not storing and displaying all metadata that providers give us. This feature ensures complete metadata visibility from providers through database to UI.

**Core Principle:** All new fields are **read-only reference information** from providers. If users find incorrect data, they can identify the source and know it came from TMDB/TVDB.

**Scope:** Focus on provider → database → UI pipeline. XML/NFO export (Publishing phase) is out of scope for this feature.

---

## Scope

### In Scope

**Database:**
- Add 6 new metadata columns to movies table (budget, revenue, homepage, original_language, popularity, status)
- Create movie_external_ids table for social/data source IDs (facebook, instagram, twitter, wikidata)
- NO lock columns (all new fields read-only)
- Add performance indexes

**Backend:**
- Update enrichment to copy 6 new fields from provider cache
- Populate external_ids table during enrichment
- Join external_ids in movie detail API
- Build provider URLs dynamically from IDs
- Add language name mapping utility

**Frontend:**
- Add Stats section (Budget, Revenue, Popularity)
- Add Production Info section (Status, Original Language)
- Add External Links section (clickable badges for all provider/social IDs)
- Add Technical Details section (video/audio streams - read-only)
- Display full language names instead of ISO codes
- Compact badge UI for external links

### Out of Scope

- XML/NFO generation updates (Publishing phase unaffected)
- Collection support (separate feature - too large)
- Adult content flag (not used by media players)
- Editable new fields (all read-only)
- Lock columns for new fields (not needed)
- TV show metadata (focus on movies first)
- Filtering/sorting by new fields in list view (detail view only)

---

## Technical Design

### Database Changes (Morgan)

#### Add to movies table (6 new columns - all read-only):

```sql
-- New metadata fields
ALTER TABLE movies ADD COLUMN budget INTEGER;
ALTER TABLE movies ADD COLUMN revenue INTEGER;
ALTER TABLE movies ADD COLUMN homepage TEXT;
ALTER TABLE movies ADD COLUMN original_language TEXT;
ALTER TABLE movies ADD COLUMN popularity REAL;
ALTER TABLE movies ADD COLUMN status TEXT;
```

**NO lock columns needed** - all fields are read-only reference data from providers.

#### Create external IDs table (wide table - Morgan's recommendation):

```sql
CREATE TABLE movie_external_ids (
  movie_id INTEGER PRIMARY KEY,
  facebook_id TEXT,
  instagram_id TEXT,
  twitter_id TEXT,
  wikidata_id TEXT,
  FOREIGN KEY (movie_id) REFERENCES movies(id) ON DELETE CASCADE
);
```

**Why wide table:**
- Performance: Single row read for movie detail view
- Known domain: ~4-6 sites, won't balloon to 50+
- Type safety: Better TypeScript types
- Simple queries: No aggregation needed

**Provider IDs (tmdb_id, imdb_id, tvdb_id) stay in movies table** - they're core identifiers used for enrichment matching, not just display links.

#### Add performance indexes:

```sql
CREATE INDEX idx_movies_popularity ON movies(popularity DESC);
CREATE INDEX idx_movies_budget ON movies(budget DESC);
CREATE INDEX idx_movies_revenue ON movies(revenue DESC);
CREATE INDEX idx_movies_status ON movies(status);
CREATE INDEX idx_movies_original_language ON movies(original_language);
```

**Migration File:** `src/database/migrations/0XX_metadata_completeness.ts`

---

### Backend Changes (Jordan)

#### Updated GET /api/movies/:id Response

**New fields added to response:**

```typescript
{
  // NEW metadata fields (read-only)
  budget: number | null,
  revenue: number | null,
  homepage: string | null,
  original_language: string | null,  // ISO code
  popularity: number | null,
  status: string | null,

  // NEW external_ids object (from joined table)
  external_ids: {
    facebook_id: string | null,
    instagram_id: string | null,
    twitter_id: string | null,
    wikidata_id: string | null
  },

  // NEW provider URLs (computed server-side from IDs)
  provider_urls: {
    tmdb_url: string | null,
    imdb_url: string | null,
    tvdb_url: string | null,
    facebook_url: string | null,
    instagram_url: string | null,
    twitter_url: string | null,
    wikidata_url: string | null,
    homepage_url: string | null  // From homepage field
  },

  // NEW video/audio streams (when include=streams)
  video_streams: Array<{
    codec: string,
    width: number,
    height: number,
    bitrate: number,
    // ... full stream data
  }> | null,

  audio_streams: Array<{
    codec: string,
    channels: number,
    language: string,
    // ... full stream data
  }> | null
}
```

#### Service Layer Changes

**MovieService.getById():**
- Add LEFT JOIN to movie_external_ids table
- Conditionally JOIN video_streams and audio_streams (when `include=streams`)
- Build provider_urls object from IDs using utility function
- Build external_ids object from joined data

**ProviderFetchPhase.copyMetadataToMovie():**
- Add 6 new field mappings (NO lock checks needed - read-only)
- Copy budget, revenue, homepage, original_language, popularity, status from cached movie

**ProviderFetchPhase (new method):**
- `copyExternalIds(movieId, cachedMovie)` - Populate movie_external_ids table from TMDB external_ids

**URL Building Utility:**

```typescript
// src/utils/externalIds.ts
const EXTERNAL_ID_PATTERNS: Record<string, (id: string) => string> = {
  facebook: (id) => `https://www.facebook.com/${id}`,
  instagram: (id) => `https://www.instagram.com/${id}`,
  twitter: (id) => `https://twitter.com/${id}`,
  wikidata: (id) => `https://www.wikidata.org/wiki/${id}`,
  imdb: (id) => `https://www.imdb.com/title/${id}`,
  tmdb: (id) => `https://www.themoviedb.org/movie/${id}`,
  tvdb: (id) => `https://www.thetvdb.com/dereferrer/movie/${id}`,
};

export function buildExternalUrl(site: string, id: string): string {
  const pattern = EXTERNAL_ID_PATTERNS[site];
  return pattern ? pattern(id) : id;
}
```

**Language Name Utility:**

```typescript
// src/utils/languages.ts
const LANGUAGE_NAMES: Record<string, string> = {
  en: 'English',
  ja: 'Japanese',
  fr: 'French',
  es: 'Spanish',
  de: 'German',
  it: 'Italian',
  pt: 'Portuguese',
  ko: 'Korean',
  zh: 'Chinese',
  ru: 'Russian',
  // ... full ISO 639-1 mapping
};

export function getLanguageName(isoCode: string | null): string {
  if (!isoCode) return 'Unknown';
  return LANGUAGE_NAMES[isoCode] || isoCode.toUpperCase();
}
```

**No validation needed** - Data comes from providers, trusted at source.

---

### UI Changes (Casey)

#### New Sections in Movie Details View (All Read-Only)

**1. Stats Section**

Location: Below Core Metadata

Layout (compact grid):
- **Budget:** $123,456,789 (or "Unknown" if null)
- **Revenue:** $836,800,000 (or "Unknown" if null)
- **Popularity:** 85.4 (with TMDB icon/context)

Visual: Read-only text/numeric displays, no inputs, no lock icons

**2. Production Info Section**

Location: Below Stats

Layout (compact):
- **Status:** Color-coded badge (Released=green, Post Production=yellow, In Production=blue, Rumored=gray)
- **Original Language:** "English" (full name, not ISO code)

Visual: Badges and read-only text, muted styling

**3. External Links Section**

Location: Below Production Info

Layout: Compact badge grid (responsive - 4 cols desktop, 2 cols mobile)

**Provider Badges (always first):**
- TMDB badge → `https://themoviedb.org/movie/{tmdb_id}`
- IMDB badge → `https://imdb.com/title/{imdb_id}`
- TVDB badge → `https://thetvdb.com/movie/{tvdb_id}` (if available)

**Official Site:**
- Homepage badge → `{homepage}` (if available)

**Social/Data Links (if available):**
- Facebook badge → `https://facebook.com/{facebook_id}`
- Instagram badge → `https://instagram.com/{instagram_id}`
- Twitter badge → `https://twitter.com/{twitter_id}`
- Wikidata badge → `https://wikidata.org/wiki/{wikidata_id}`

Visual: Small compact badges/buttons with icons, minimal real estate, disabled/hidden if ID is null

**4. Technical Details Section**

Location: Bottom of page

Layout: 2-column read-only data grid
- **Video:** Codec, Resolution, Bitrate, HDR Type
- **Audio:** Codec, Channels, Language, Bitrate
- **File:** Container, Size, Duration

Visual: Muted background (bg-neutral-800/30), gray text, tooltip "Extracted from file"

#### Component Requirements

**New Components:**

1. **ProviderBadge.tsx** - Clickable provider ID chip
   - Props: `provider` ('tmdb' | 'imdb' | 'tvdb' | 'homepage' | 'facebook' | etc.), `id` (string | number)
   - Renders: Icon + label + external link indicator
   - Opens provider URL in new tab

2. **ReadOnlyDataGrid.tsx** - Structured read-only technical data
   - Props: `sections` (array of {label, value} pairs)
   - Renders: 2-column grid with muted styling

3. **StatusBadge.tsx** - Color-coded status indicator
   - Props: `status` (string)
   - Renders: Badge with color mapping

4. **CurrencyDisplay.tsx** - Formatted currency display
   - Props: `value` (number | null), `label` (string)
   - Renders: Formatted as $X,XXX,XXX or "Unknown"

5. **PopularityIndicator.tsx** - Visual popularity metric
   - Props: `value` (number | null)
   - Renders: Numeric display with TMDB icon/context

**Modified Components:**

- **MetadataTab.tsx** - Add 4 new sections (Stats, Production Info, External Links, Technical Details)
- **MovieDetail types** - Extend interface with new fields

#### Accessibility

- **ARIA labels:** "Open {provider} page in new tab" for provider badges
- **Keyboard navigation:** All badges keyboard accessible (Enter/Space to activate)
- **Screen reader:** Announce "read-only" state, currency values read correctly
- **Focus management:** Visible focus rings on all interactive elements

---

## Implementation Tasks

### Phase 1: Database Foundation

- [ ] Create migration `0XX_metadata_completeness.ts`
- [ ] Add 6 metadata columns to movies table
- [ ] Create movie_external_ids table
- [ ] Add 5 performance indexes
- [ ] Test migration on SQLite and PostgreSQL
- [ ] Update DATABASE.md documentation

### Phase 2: Backend Data Flow

- [ ] Update MovieService.getById() - join external_ids, streams
- [ ] Add ProviderFetchPhase.copyExternalIds() method
- [ ] Update ProviderFetchPhase.copyMetadataToMovie() - add 6 field mappings
- [ ] Update ProviderFetchPhase.execute() - call copyExternalIds()
- [ ] Create buildExternalUrl() utility function
- [ ] Create getLanguageName() utility function
- [ ] Update CompleteMovieData interface (add external_ids if needed)
- [ ] Update MovieDetail response types
- [ ] Update API.md documentation

### Phase 3: Frontend Display

- [x] Create ProviderBadge.tsx component
- [x] Create ReadOnlyDataGrid.tsx component
- [x] Create StatusBadge.tsx component
- [x] Update MetadataTab.tsx - add Production & Stats section (combined Financial Data and Release Status badges)
- [x] Update MetadataTab.tsx - add External Links section
- [x] Update MetadataTab.tsx - add Technical Details section
- [x] Update MovieDetail interface (add new fields)
- [x] Update MetadataTab.tsx - add Base Metadata section wrapper
- [x] Update MetadataTab.tsx - rename Related Entities to Extended Metadata
- [x] Update MetadataTab.tsx - add directory path display
- [x] Update MetadataTab.tsx - equalize TagInput heights with bottom-aligned buttons
- [x] Update MetadataTab.tsx - multi-column layout for Extended Metadata
- [ ] Add useMovieDetail hook updates (include=streams) - deferred, streams already available
- [ ] Update COMPONENTS.md documentation

### Phase 4: Testing & Polish

- [ ] Unit tests: ProviderFetchPhase field mapping (6 new fields)
- [ ] Unit tests: copyExternalIds() method
- [ ] Unit tests: buildExternalUrl() utility
- [ ] Unit tests: getLanguageName() utility
- [ ] Integration tests: GET /api/movies/:id response shape
- [ ] Manual testing: Enrich a movie, verify 6 fields populated
- [ ] Manual testing: UI displays all new sections correctly
- [ ] Manual testing: Provider badges clickable, open correct URLs
- [ ] Manual testing: Currency formatting correct
- [ ] Manual testing: Language names display correctly
- [ ] Manual testing: Technical details display correctly
- [ ] Update ROADMAP.md - mark feature complete

---

## Success Criteria

- [ ] All 6 new metadata fields stored in database
- [ ] External IDs table populated during enrichment
- [ ] API returns all new fields in movie detail response
- [ ] Provider URLs computed and returned correctly
- [ ] Video/audio streams joined when `include=streams` requested
- [ ] UI displays Stats section with formatted currency
- [ ] UI displays Production Info section with status badge and language name
- [ ] UI displays External Links section with compact clickable badges
- [ ] UI displays Technical Details section (read-only, muted)
- [ ] Provider badges open correct URLs in new tab
- [ ] Language displays full name ("English") not ISO code ("en")
- [ ] All new fields clearly read-only (no lock icons, muted styling)
- [ ] All tests pass (unit + integration + manual)
- [ ] Documentation updated (DATABASE.md, API.md, COMPONENTS.md)
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Backend builds successfully
- [ ] Frontend builds successfully

---

## Risks & Mitigations

**Risk 1: Schema Expansion (6 new columns)**
- **Mitigation:** These are frequently-accessed display fields, justified for performance. External IDs in separate table to contain bloat.

**Risk 2: Migration Complexity**
- **Mitigation:** Non-breaking migration (NULL defaults). Backfill via normal enrichment (forceRefresh=false uses cache). Gradual enrichment acceptable.

**Risk 3: Performance (Extra JOINs)**
- **Mitigation:** external_ids table uses PRIMARY KEY on movie_id (fast JOIN). Stream joins conditional (include=streams). Indexes on new columns for sorting.

**Risk 4: Provider Data Quality**
- **Mitigation:** Display "Unknown" if NULL. Fields are read-only, so user knows data comes from provider. Can't "fix" bad data directly, but can see source.

**Risk 5: TMDB External IDs Missing**
- **Mitigation:** Graceful NULL handling. Only show badges for IDs that exist. Empty external links section if no IDs available.

**Risk 6: URL Pattern Changes**
- **Mitigation:** URLs built dynamically from patterns in code. Easy to update if provider changes domain/URL structure.

**Risk 7: UI Clutter**
- **Mitigation:** Compact badge design takes minimal space. Sections collapsible on mobile. Read-only sections muted to de-emphasize.

---

## Design Decisions & Rationale

### 1. All New Fields Read-Only

**Decision:** No editable fields, no lock columns

**Rationale:**
- These are reference data from providers
- User can see source (TMDB badge) and verify
- If data is wrong, user knows to check provider source
- Simpler implementation (no lock logic)
- Clearer UX (badges = not editable)

### 2. Wide Table for External IDs

**Decision:** One column per site (facebook_id, instagram_id, etc.)

**Rationale:**
- Optimized for movie detail view (single row read)
- Known, stable domain (~4-6 sites)
- Better TypeScript type safety
- Simpler queries (no aggregation)
- Migration cost low (add column every 6-12 months)

### 3. Store ID Stubs, Build URLs Dynamically

**Decision:** Store "inception" not "https://facebook.com/inception"

**Rationale:**
- URLs can change (domain migrations, HTTPS upgrades)
- Smaller database storage
- Single source of truth for URL patterns
- Easy to update if provider changes URL structure

### 4. Keep Provider IDs in Movies Table

**Decision:** tmdb_id, imdb_id, tvdb_id stay in movies table

**Rationale:**
- Core identifiers used for enrichment matching
- Performance critical (job queue filters by these)
- Used in foreign keys throughout system
- Moving them would be breaking change

### 5. No Collection Support

**Decision:** Skip collection_id FK and collection linking

**Rationale:**
- Collection support is a large feature (collection detail view, navigation, etc.)
- Deserves its own planning and implementation
- Not critical for metadata completeness goal
- Can be added later without affecting this feature

### 6. No Adult Flag

**Decision:** Don't store or display adult content flag

**Rationale:**
- Media players don't use this field
- Adds clutter without benefit
- MPAA rating (content_rating) already indicates mature content
- Not needed for user's goal

### 7. Display Language Names, Not ISO Codes

**Decision:** Show "English" instead of "en"

**Rationale:**
- More beginner-friendly
- Users don't know ISO 639-1 codes
- Still store ISO code in DB (standard format)
- Convert to full name in UI only

---

## Future Enhancements (Out of Scope)

- Filter/sort movies by budget, revenue, popularity in list view
- Collection support (detail view, navigation, member management)
- Multi-language support (fetch plot/title in user's language)
- Keyword display and filtering
- Release dates per-country (TMDB certifications)
- User-specific favorites/watchlist (requires auth)
- XML/NFO export updates (Publishing phase)
- TV show metadata completeness
- Editable external IDs (if user wants to add custom links)

---

**End of Feature Specification**
